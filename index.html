<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>EPhone</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <style>
        :root { --screen-width: 390px; --screen-height: 740px; --secondary-bg: #ffffff; --border-color: #e0e0e0; --text-primary: #1f1f1f; --text-secondary: #8a8a8a; --accent-color: #007bff; }
        html { height: 100%; overflow: hidden; }
        body { height: 100%; overflow: hidden; margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-weight: normal; background-color: #dcdcdc; display: flex; justify-content: center; align-items: center; box-sizing: border-box; }
        #phone-frame { padding: 12px; background-color: #fff; border-radius: 50px; box-shadow: 0 20px 50px rgba(0,0,0,0.25), inset 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .notch { position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 130px; height: 28px; background-color: #1f1f1f; border-radius: 0 0 15px 15px; z-index: 20; }
        #phone-screen { width: var(--screen-width); height: var(--screen-height); background-color: #000; border-radius: 40px; position: relative; overflow: hidden; display: flex; flex-direction: column; border: 2px solid #333; }
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; color: white; z-index: 10; font-size: 14px; box-sizing: border-box; pointer-events: none; }
        #status-bar-time { font-weight: 600; }
        .battery-container { display: flex; align-items: center; gap: 5px; }
        .battery-icon { width: 25px; height: 12px; border: 1px solid white; border-radius: 3px; position: relative; padding: 1px; }
        .battery-icon::after { content: ''; position: absolute; right: -3px; top: 2px; width: 2px; height: 6px; background-color: white; border-radius: 0 1px 1px 0; }
        .battery-level { height: 100%; background-color: white; border-radius: 1px; transition: width 0.5s ease; }
        .battery-container.charging .battery-level { background-color: #4cd964; animation: charge-breath 2s infinite; }
        .battery-container.charging .battery-text { color: #4cd964; }
        @keyframes charge-breath { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow: hidden; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .screen.active { opacity: 1; visibility: visible; z-index: 1; }
        .header { position: relative; z-index: 15; flex-shrink: 0; padding: 15px 20px; padding-top: 45px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: 600; }
        .header .header-actions { display: flex; align-items: center; gap: 15px; }
        .header .back-btn, .header .action-btn { font-size: 24px; cursor: pointer; width: 30px; text-align: center; color: var(--accent-color); display: flex; align-items: center; justify-content: center; }
        .header .action-btn img { height: 26px; }
        .header .save-btn { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; }
        #home-screen { display: flex; flex-direction: column; justify-content: flex-start; align-items: center; padding: 20px; padding-top: 80px; padding-bottom: 50px; box-sizing: border-box; background-size: cover; background-position: center; }
        #clock-container { text-align: center; color: white; text-shadow: 0 3px 8px rgba(0,0,0,0.4); margin-bottom: 20px; flex-shrink: 0; }
        #main-time { font-size: 80px; font-weight: 200; }
        #main-date { font-size: 18px; font-weight: 500; }
        #app-grid { margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 20px; width: 100%; padding: 20px; }
        .app-row { display: flex; justify-content: center; gap: 25px; width: 100%; }
        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); font-size: 14px; font-weight: 500; text-align: center; }
        .app-icon .icon-bg { width: 65px; height: 65px; border-radius: 18px; background-color: var(--secondary-bg); display: flex; justify-content: center; align-items: center; font-size: 32px; margin-bottom: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.15); transition: transform 0.2s ease; overflow: hidden; }
        .app-icon:active .icon-bg { transform: scale(0.9); }
        .app-icon .icon-bg img { width: 100%; height: 100%; object-fit: cover; }
        .app-icon .label { color: white; }
        .form-container, .list-container { padding: 20px; overflow-y: auto; flex-grow: 1; display:flex; flex-direction: column; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        #world-book-content-input { height: calc(100% - 120px); }
        .form-button { width: 100%; padding: 15px; background-color: var(--accent-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 10px; }
        .form-button-secondary { background-color: #f0f0f0; color: var(--text-primary); border: 1px solid var(--border-color); }
        #wallpaper-screen .form-container { align-items: center; }
        #wallpaper-preview { width: 180px; height: 320px; border: 2px dashed var(--border-color); background-color: #f0f2f5; margin-bottom: 20px; background-size: cover; background-position: center; border-radius: 10px; display: flex; justify-content: center; align-items: center; color: var(--text-secondary); }
        #wallpaper-upload-input { display: none; }
        #chat-list, #world-book-list { flex-grow: 1; overflow-y: auto; background-color: var(--secondary-bg); padding-top: 80px; margin-top: -80px; }
        .list-item { display: flex; flex-direction: column; padding: 12px 20px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .list-item:hover { background-color: #f5f5f5; }
        .list-item .item-title { font-weight: 500; font-size: 16px; margin-bottom: 5px; }
        .list-item .item-content { font-size: 14px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-list-item { display: flex; align-items: center; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); position: relative; }
        .chat-list-item:hover { background-color: #f5f5f5; }
        .chat-list-item .avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; background-color: #ccc; }
        .chat-list-item .info { flex-grow: 1; overflow: hidden; }
        .chat-list-item .name-line { display: flex; align-items: center; gap: 6px; margin-bottom: 2px; }
        .chat-list-item .name { font-weight: 500; color: var(--text-primary); }
        .chat-list-item .group-tag { font-size: 10px; color: var(--accent-color); background-color: #e7f3ff; padding: 2px 6px; border-radius: 4px; font-weight: bold; flex-shrink: 0; }
        .chat-list-item .last-msg { font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }
        #chat-interface-screen { background-size: cover; background-position: center; position: relative; }
        #chat-interface-screen .header .default-controls, #chat-interface-screen .header .selection-controls { display: contents; }
        #chat-interface-screen.selection-mode .default-controls { display: none; }
        #chat-interface-screen:not(.selection-mode) .selection-controls { display: none; }
        #selection-cancel-btn, #selection-delete-btn { font-size: 16px; color: var(--accent-color); cursor: pointer; padding: 5px; }
        #selection-delete-btn { color: #ff3b30; }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; padding-top: 80px; margin-top: -80px; display: flex; flex-direction: column; gap: 8px; }
        #load-more-btn { text-align: center; padding: 10px; color: var(--accent-color); font-size: 14px; cursor: pointer; background-color: transparent; border: none; width: 100%; }
        #load-more-btn:hover { text-decoration: underline; }
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .message-wrapper.user { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.ai { align-self: flex-start; align-items: flex-start; }
        .sender-name { font-size: 11px; color: #666; margin-bottom: 3px; }
        .message-wrapper.ai .sender-name { margin-left: 37px; }
        .message-bubble { display: flex; align-items: flex-start; gap: 5px; position: relative; width: -webkit-fit-content; width: -moz-fit-content; width: fit-content; max-width: 100%; }
        .message-bubble.selected::after { content: '‚úî'; position: absolute; left: -10px; top: 50%; transform: translateY(-50%); background-color: var(--accent-color); color: white; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; }
        .message-bubble.user.selected::after { left: auto; right: -10px; }
        .avatar-group { display: flex; flex-direction: column; align-items: center; gap: 4px; flex-shrink: 0; width: 32px; }
        .message-bubble .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .timestamp { font-size: 10px; color: #b0b0b0; }
        .message-bubble .content { padding: 8px 12px; word-break: break-word; line-height: 1.5; font-size: 15px; position: relative; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.6), 0 3px 6px rgba(0,0,0,0.15); border: 1px solid rgba(255, 255, 255, 0.2); transition: background-color 0.3s, color 0.3s; }
        .message-bubble.user { flex-direction: row-reverse; }
        #typing-indicator { align-self: flex-start; display: none; margin: 0 10px 10px; color: var(--text-secondary); }
        #chat-input-area { flex-shrink: 0; padding: 8px; background-color: rgba(247, 247, 247, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        #chat-input-main-row { display: flex; align-items: flex-end; gap: 8px; width: 100%; }
        #chat-input { flex-grow: 1; border: none; padding: 10px 15px; border-radius: 20px; background-color: var(--secondary-bg); font-size: 16px; max-height: 100px; resize: none; }
        .action-button { border: none; color: white; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 14px; flex-shrink: 0; }
        #send-btn { background-color: var(--accent-color); height: 40px; padding: 0 15px;}
        .modal { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-height: 90%; background-color: white; border-radius: 15px; display: flex; flex-direction: column; }
        .modal-header { padding: 15px; font-weight: 600; border-bottom: 1px solid var(--border-color); text-align: center; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 15px; overflow-y: auto; }
        .modal-footer { padding: 15px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-around; }
        .modal-footer button { width: 45%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent-color); cursor: pointer; font-size: 16px; }
        .modal-footer .save { background-color: var(--accent-color); color: white; }
        .modal-footer .cancel { background-color: white; color: var(--accent-color); }
        .avatar-upload { display: flex; align-items: center; gap: 15px; }
        .avatar-upload img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; background-color: #eee; }
        .avatar-upload button { padding: 8px 12px; border: 1px solid #ccc; background-color: #f0f0f0; border-radius: 5px; cursor: pointer; }
        #open-persona-library-btn { font-size: 14px; padding: 6px 10px; margin-left: auto; }
        .avatar-upload input[type="file"] { display: none; }
        .theme-selector label { display: inline-flex; align-items: center; margin-right: 15px; margin-bottom: 5px; cursor: pointer; }
        #reset-theme-btn { background: none; border: 1px solid #ccc; color: #555; font-size: 12px; padding: 2px 8px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        #group-members-settings { display: flex; overflow-x: auto; padding-bottom: 10px; gap: 15px; }
        .member-editor { text-align: center; cursor: pointer; }
        .member-editor img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: #eee; margin-bottom: 5px; }
        .member-editor .member-name { font-size: 12px; }
        #notification-bar { position: absolute; top: 40px; left: 5%; width: 90%; z-index: 500; background-color: rgba(250, 250, 250, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 16px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 12px; cursor: pointer; transform: translateY(-150%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); visibility: hidden; }
        #notification-bar.visible { transform: translateY(0); visibility: visible; }
        #notification-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        #notification-content .name { font-weight: 600; font-size: 15px; color: #000; }
        #notification-content .message { font-size: 14px; color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .sticker-image { max-width: 100px; max-height: 100px; display: block; object-fit: contain; }
        .message-bubble.is-sticker .content, .message-bubble.is-voice-message .content { padding: 0; background-color: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        #chat-input-actions-top { display: flex; gap: 8px; padding: 0 5px; }
        .chat-action-icon-btn { font-size: 24px; padding: 0; width: 38px; height: 38px; line-height: 38px; text-align: center; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); color: var(--text-primary); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.05); cursor: pointer; display:flex; justify-content:center; align-items:center; }
        #sticker-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background-color: rgba(242, 242, 247, 0.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 200; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-panel-header { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); }
        #sticker-panel-header .title { font-weight: 600; }
        #sticker-panel-header .panel-btn { font-size: 16px; padding: 5px 10px; cursor: pointer; color: var(--accent-color); }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-item .delete-btn { display: none; position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background-color: #ff3b30; color: white; border-radius: 50%; text-align: center; line-height: 20px; font-size: 14px; cursor: pointer; border: 2px solid white; }
        #input-actions-wrapper { position: static; display: flex; align-items: flex-end; gap: 8px; flex-shrink: 0; }
        #wait-reply-btn { position: static; bottom: auto; right: auto; width: auto; height: 40px; padding: 0 10px; border-radius: 20px; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: opacity 0.2s, transform 0.1s; cursor: pointer;}
        #wait-reply-btn:hover { opacity: 0.8; }
        #wait-reply-btn:active { transform: scale(0.9); }
        #wait-reply-btn img { height: 22px; display: block; margin: auto; }
        .chat-image { max-width: 100%; border-radius: 10px; display: block; }
        .message-bubble.has-image .content { padding: 5px; }
        #custom-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s ease-in-out; }
        #custom-modal-overlay.visible { display: flex; opacity: 1; }
        #custom-modal { background-color: #fff; width: 280px; border-radius: 14px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.2s ease-in-out; }
        #custom-modal-overlay.visible #custom-modal { transform: scale(1); }
        .custom-modal-header { padding: 16px; font-size: 17px; font-weight: 600; text-align: center; }
        .custom-modal-body { padding: 0 16px 16px; text-align: center; font-size: 14px; color: #333; line-height: 1.5; }
        .custom-modal-body p { margin: 0; margin-bottom: 12px; }
        .custom-modal-body input { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; box-sizing: border-box; }
        .custom-modal-footer { border-top: 1px solid #dbdbdb; display: flex; }
        .custom-modal-footer button { flex: 1; background: none; border: none; padding: 12px; font-size: 17px; cursor: pointer; color: var(--accent-color); }
        .custom-modal-footer button:first-child { border-right: 1px solid #dbdbdb; }
        .custom-modal-footer .confirm-btn { font-weight: 600; }
        .custom-modal-footer .confirm-btn.btn-danger { color: #ff3b30; }
        #preset-actions-modal .custom-modal-footer { flex-direction: column; }
        #preset-actions-modal .custom-modal-footer button { width: 100%; border: none; border-bottom: 1px solid #dbdbdb; padding: 14px; font-size: 18px; }
        #preset-actions-modal .custom-modal-footer button:last-child { border-bottom: none; }
        .custom-multiselect { position: relative; user-select: none; }
        .select-box { display: flex; align-items: center; width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 16px; box-sizing: border-box; background-color: #fff; cursor: pointer; }
        .select-box .selected-options-text { flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
        .select-box .arrow-down { margin-left: auto; font-size: 10px; color: var(--text-secondary); transition: transform 0.2s; }
        .select-box.expanded .arrow-down { transform: rotate(180deg); }
        .checkboxes-container { display: none; position: absolute; top: 105%; left: 0; right: 0; max-height: 150px; overflow-y: auto; background-color: #fff; border: 1px solid var(--border-color); border-radius: 8px; z-index: 101; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .checkboxes-container.visible { display: block; }
        .checkboxes-container label { display: block; padding: 10px 12px; cursor: pointer; font-weight: normal; color: var(--text-primary); }
        .checkboxes-container label:hover { background-color: #f5f5f5; }
        .checkboxes-container input { margin-right: 10px; vertical-align: middle; }
        .bg-upload-container { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
        .bg-preview-img { max-width: 120px; max-height: 80px; border-radius: 8px; border: 1px solid var(--border-color); object-fit: cover; display: none; }
        #remove-bg-btn { padding: 8px 12px; border: 1px solid #ff3b30; color: #ff3b30; background-color: #fff; border-radius: 5px; cursor: pointer; font-size: 14px; display: none; }
        .message-bubble.is-ai-image .content { padding: 5px; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; }
        .ai-generated-image { max-width: 180px; border-radius: 12px; display: block; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .ai-generated-image:hover { transform: scale(1.05); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .voice-message-body { display: flex; align-items: center; cursor: pointer; padding: 8px 12px; min-width: 80px; max-width: 200px; }
        .message-bubble.user .voice-message-body { color: #1a3d00; flex-direction: row-reverse; }
        .message-bubble.ai .voice-message-body { color: var(--text-primary); }
        .voice-waveform { display: flex; align-items: center; height: 20px; gap: 2px; flex-grow: 1; margin: 0 10px; }
        .voice-waveform div { width: 3px; background-color: currentColor; border-radius: 2px; animation: wave-quiet 1.5s ease-in-out infinite; }
        @keyframes wave-quiet { 0%, 100% { height: 2px; } 50% { height: 10px; } }
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; } .voice-waveform div:nth-child(3) { animation-delay: 0.4s; } .voice-waveform div:nth-child(4) { animation-delay: 0.6s; } .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }
        .voice-duration { font-size: 13px; font-weight: 500; color: var(--text-secondary); }
        .message-bubble.user .voice-duration { color: #3e6224; }

        /* === Ê∞îÊ≥°‰∏ªÈ¢òÊ†∑Âºè === */
        .message-bubble.user .content { background-color: rgba(160, 233, 86, 0.75); color: #1a3d00; border-radius: 20px 8px 20px 20px; }
        .message-bubble.ai .content { background-color: rgba(255, 255, 255, 0.7); color: var(--text-primary); border-radius: 8px 20px 20px 20px; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.user .content { background-color: #FADADD; color: #5D3A3A; }
        #chat-messages[data-theme="pink_blue"] .message-bubble.ai .content { background-color: #D6EAF8; color: #283747; }
        #chat-messages[data-theme="blue_white"] .message-bubble.user .content { background-color: #cce5ff; color: #004085; }
        #chat-messages[data-theme="blue_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.user .content { background-color: #E6E6FA; color: #4B0082; }
        #chat-messages[data-theme="purple_yellow"] .message-bubble.ai .content { background-color: #FFFACD; color: #5C4033; }
        #chat-messages[data-theme="black_white"] .message-bubble.user .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="black_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #343a40; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.user .content { background-color: #FFEB3B; color: #5D4037; }
        #chat-messages[data-theme="yellow_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="red_black"] .message-bubble.user .content { background-color: #C62828; color: #FFFFFF; }
        #chat-messages[data-theme="red_black"] .message-bubble.ai .content { background-color: #212121; color: #FFFFFF; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.user .content { background-color: #A0D2EB; color: #153243; }
        #chat-messages[data-theme="blue_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_yellow"] .message-bubble.ai .content { background-color: #FEF9E7; color: #5D4037; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_purple"] .message-bubble.ai .content { background-color: #E6E6FA; color: #4B0082; }
        #chat-messages[data-theme="gray_white"] .message-bubble.user .content { background-color: #e9ecef; color: #495057; }
        #chat-messages[data-theme="gray_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="blue_green"] .message-bubble.user .content { background-color: #d1ecf1; color: #0c5460; }
        #chat-messages[data-theme="blue_green"] .message-bubble.ai .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="pink_white"] .message-bubble.user .content { background-color: #fce4ec; color: #880e4f; }
        #chat-messages[data-theme="pink_white"] .message-bubble.ai .content { background-color: #f8f9fa; color: #383d41; }
        #chat-messages[data-theme="pink_black"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }
        #chat-messages[data-theme="pink_green"] .message-bubble.user .content { background-color: #F8BBD0; color: #5B2C6F; }
        #chat-messages[data-theme="pink_green"] .message-bubble.ai .content { background-color: #C8E6C9; color: #1B5E20; }
        #chat-messages[data-theme="green_black"] .message-bubble.user .content { background-color: #d4edda; color: #155724; }
        #chat-messages[data-theme="green_black"] .message-bubble.ai .content { background-color: #343a40; color: #f8f9fa; }

        #transfer-btn { font-weight: bold; }
        #transfer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1001; }
        #transfer-modal.visible { display: flex; }
        .transfer-content { background-color: #fff0f5; border-radius: 20px; width: 290px; padding: 20px; box-shadow: 0 5px 25px rgba(255, 105, 180, 0.3); text-align: center; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100" opacity="0.05"><path d="M50,4 C35,4 28,15 28,24 C28,33 35,32 35,40 C35,48 28,49 28,57 C28,65 35,66 35,74 C35,82 28,83 28,91 C28,99 35,100 50,100 C65,100 72,99 72,91 C72,83 65,82 65,74 C65,66 72,65 72,57 C72,49 65,48 65,40 C65,32 72,33 72,24 C72,15 65,4 50,4 Z" fill="%23FF69B4"/></svg>'); background-repeat: no-repeat; background-position: top right; background-size: 80px; }
        .transfer-header { font-size: 20px; font-weight: bold; color: #a35c7b; margin-bottom: 20px; }
        .transfer-input-group { margin-bottom: 15px; text-align: left; }
        .transfer-input-group label { display: block; font-size: 14px; color: #ff85b3; margin-bottom: 5px; font-weight: 500; }
        .transfer-input-group input { width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #ffcce0; background-color: #fff; font-size: 16px; box-sizing: border-box; }
        .transfer-input-group input:focus { border-color: #ff85b3; outline: none; }
        .transfer-actions { display: flex; justify-content: space-between; gap: 10px; }
        .transfer-actions button { flex: 1; padding: 12px; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; transition: transform 0.2s; }
        .transfer-actions button:active { transform: scale(0.95); }
        #transfer-cancel-btn { background-color: #ffdde9; color: #a35c7b; }
        #transfer-confirm-btn { background-color: #ff85b3; color: white; }
        .message-bubble.is-transfer .content { padding: 0; background: transparent; box-shadow: none; border: none; backdrop-filter: none; -webkit-backdrop-filter: none; cursor: pointer; }
        .transfer-card { width: 200px; border-radius: 12px; padding: 12px; color: white; position: relative; overflow: hidden; }
        .transfer-card::before { content: 'üêæ'; position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .message-bubble.user .transfer-card { background: radial-gradient(circle at top left, #ffc5d5, #ff85b3); }
        .message-bubble.ai .transfer-card { background: radial-gradient(circle at top left, #a1c4fd, #c2e9fb); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #listen-together-btn img.rotating { animation: spin 2s linear infinite; }
        #listen-together-btn img.paused { animation-play-state: paused; }
        #music-player-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; display: none; justify-content: center; align-items: center; background-color: rgba(0,0,0,0.3); }
        #music-player-overlay.visible { display: flex; }
        .music-player-window { width: 90%; background-color: rgba(255, 255, 255, 0.6); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); border: 1px solid rgba(255, 255, 255, 0.18); padding: 25px; display: flex; flex-direction: column; align-items: center; color: #1f1f1f; position: relative; }
        #music-playlist-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; color: #333; }
        #music-time-counter { font-size: 12px; color: #555; margin-bottom: 20px; }
        #music-player-song-title { font-size: 20px; font-weight: 600; margin-bottom: 5px; text-align: center; }
        #music-player-artist { font-size: 14px; color: #666; margin-bottom: 25px; }
        .music-controls { display: flex; align-items: center; justify-content: center; gap: 20px; width: 100%; margin-bottom: 30px; }
        .music-controls button { background: none; border: none; font-size: 16px; font-weight: bold; cursor: pointer; color: #333; width: 44px; height: 44px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; }
        .music-controls button:active { transform: scale(0.9); }
        .music-controls .play-pause-btn { font-size: 24px; width: 60px; height: 60px; border-radius: 50%; background-color: rgba(0,0,0,0.05); }
        .music-bottom-actions { display: flex; justify-content: space-between; width: 100%; }
        .music-bottom-actions button { flex: 1; padding: 12px 0; border: none; border-radius: 10px; font-size: 15px; font-weight: 500; cursor: pointer; }
        #music-exit-btn { background-color: rgba(255, 100, 100, 0.7); color: white; margin-right: 5px; }
        #music-return-btn { background-color: rgba(0, 123, 255, 0.7); color: white; margin-left: 5px; }
        
        #music-playlist-panel { position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background-color: rgba(242, 242, 247, 0.9); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border-color); border-radius: 20px 20px 0 0; z-index: 210; display: flex; flex-direction: column; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); visibility: hidden; }
        #music-playlist-panel.visible { transform: translateY(0); visibility: visible; }
        .playlist-header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; border-bottom: 1px solid var(--border-color); font-weight: 600; }
        .playlist-header .panel-btn { font-size: 16px; cursor: pointer; color: var(--accent-color); }
        .playlist-body { flex-grow: 1; overflow-y: auto; padding: 10px 0; }
        .playlist-item { padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid #eee; }
        .playlist-item.playing { background-color: rgba(0, 123, 255, 0.1); }
        .playlist-item-info .title { font-weight: 500; font-size: 15px; }
        .playlist-item-info .artist { font-size: 12px; color: #666; }
        .playlist-item .delete-track-btn { color: #ff3b30; font-size: 20px; padding: 5px; }

        /* Persona Library Styles */
        #persona-library-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; padding: 10px; }
        .persona-preset-item { aspect-ratio: 1 / 1; border-radius: 12px; background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid rgba(0,0,0,0.1); }
        .persona-preset-item:hover { transform: scale(1.08); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .modal-header .action-button { font-size: 16px; color: var(--accent-color); font-weight: 600; cursor: pointer; background: none; border: none; padding: 5px; }
        
        /* Battery Alert Modal Styles */
        #battery-alert-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: none; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; }
        #battery-alert-modal.visible { display: flex; opacity: 1; }
        .battery-alert-content { background-color: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); width: 280px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); text-align: center; padding: 20px; cursor: pointer; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #battery-alert-modal.visible .battery-alert-content { transform: scale(1); }
        #battery-alert-image { max-width: 100px; max-height: 100px; margin-bottom: 15px; }
        #battery-alert-text { font-size: 16px; font-weight: 500; color: #333; margin: 0; line-height: 1.4; }

    </style>
</head>
<body>
    <div id="phone-frame">
        <div class="notch"></div>
        <div id="phone-screen">
            <div id="status-bar">
                <span id="status-bar-time">12:00</span>
                <div id="status-bar-battery" class="battery-container">
                    <span class="battery-text">--%</span>
                    <div class="battery-icon">
                        <div class="battery-level"></div>
                    </div>
                </div>
            </div>
            <div id="notification-bar"><img id="notification-avatar" src=""><div id="notification-content"><div class="name"></div><div class="message"></div></div></div>
            
            <div id="home-screen" class="screen active">
                <div id="clock-container"><div id="main-time">12:00</div><div id="main-date">ÊòüÊúü‰∏Ä, 1Êúà1Êó•</div></div>
                                <div id="app-grid">
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('world-book-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/htP74QkL/1.jpg" alt="‰∏ñÁïå‰π¶"></div><span class="label">‰∏ñÁïå‰π¶</span></div>
                    </div>
                    <div class="app-row">
                        <div class="app-icon" onclick="showScreen('chat-list-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/gr2ndvPL/QQ.jpg" alt="QQ"></div><span class="label">QQ</span></div>
                        <div class="app-icon" onclick="showScreen('api-settings-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/wy631NyP/settings.jpg" alt="APIËÆæÁΩÆ"></div><span class="label">APIËÆæÁΩÆ</span></div>
                        <div class="app-icon" onclick="showScreen('wallpaper-screen')"><div class="icon-bg"><img src="https://i.postimg.cc/q6qRLdGx/photo.jpg" alt="Â£ÅÁ∫∏"></div><span class="label">Â£ÅÁ∫∏</span></div>
                    </div>
                </div>
            </div>

            <div id="world-book-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span>‰∏ñÁïå‰π¶</span><span class="action-btn" id="add-world-book-btn">+</span></div><div id="world-book-list"></div></div>
            <div id="world-book-editor-screen" class="screen">
                <div class="header">
                    <span class="back-btn" onclick="showScreen('world-book-screen')">‚Äπ</span>
                    <span id="world-book-editor-title">ÁºñËæë‰∏ñÁïå‰π¶</span>
                    <span class="save-btn" id="save-world-book-btn">‰øùÂ≠ò</span>
                </div>
                <div class="form-container">
                    <div class="form-group">
                        <label for="world-book-name-input">‰π¶Âêç</label>
                        <input type="text" id="world-book-name-input" placeholder="ËØ∑ËæìÂÖ•‰∏ñÁïå‰π¶ÁöÑÂêçÁß∞...">
                    </div>
                    <div class="form-group" style="height: 100%;">
                        <label for="world-book-content-input">ÂÜÖÂÆπ</label>
                        <textarea id="world-book-content-input" placeholder="Âú®Ê≠§Â§ÑËæìÂÖ•ËØ¶ÁªÜÁöÑ‰∏ñÁïåËßÇËÆæÂÆö..."></textarea>
                    </div>
                </div>
            </div>

            <div id="api-settings-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span>API ËÆæÁΩÆ</span><span style="width: 30px;"></span></div><div class="form-container"><p style="font-size: 14px; color: #666; background-color: #f0f0f0; padding: 10px; border-radius: 8px;">ÊèêÁ§∫: Ëã•Ë¶Å‰ΩøÁî®‚ÄúÂèëÈÄÅÂõæÁâá‚ÄùÂäüËÉΩ, ËØ∑Âä°ÂøÖÈÄâÊã©ÊîØÊåÅVision(ËßÜËßâ)ÁöÑÊ®°Âûã, Â¶Ç<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4o</code>Êàñ<code style="background-color: #e0e0e0; padding: 2px 4px; border-radius: 4px;">gpt-4-vision-preview</code>„ÄÇ</p><div class="form-group"><label for="proxy-url">Âèç‰ª£Âú∞ÂùÄ (‰∏çÈúÄË¶ÅÊ∑ªÂä†/v1Âô¢~)</label><input type="text" id="proxy-url" placeholder="‰æãÂ¶Ç: https://api.openai.com"></div><div class="form-group"><label for="api-key">ÂØÜÈí• (API Key)</label><input type="password" id="api-key" placeholder="sk-..."></div><div class="form-group"><label for="model-select">Ê®°Âûã</label><select id="model-select"></select></div><button class="form-button" id="fetch-models-btn">ÊãâÂèñÊ®°Âûã</button><button class="form-button" id="save-api-settings-btn">‰øùÂ≠òËÆæÁΩÆ</button></div></div>
            <div id="chat-list-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span>Ê∂àÊÅØ</span><div class="header-actions"><span class="action-btn" id="add-group-chat-btn" title="ÂàõÂª∫Áæ§ËÅä"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M17.5 17.5C19.1569 17.5 20.5 16.1569 20.5 14.5C20.5 12.8431 19.1569 11.5 17.5 11.5C15.8431 11.5 14.5 12.8431 14.5 14.5C14.5 16.1569 15.8431 17.5 17.5 17.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 21L19 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M8.5 11.5C10.1569 11.5 11.5 10.1569 11.5 8.5C11.5 6.84315 10.1569 5.5 8.5 5.5C6.84315 5.5 5.5 6.84315 5.5 8.5C5.5 10.1569 6.84315 11.5 8.5 11.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12.5 14.5H4.5C3.39543 14.5 2.5 15.3954 2.5 16.5V18.5H12.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span><span class="action-btn" id="add-chat-btn">+</span></div></div><div id="chat-list"></div></div>
            
            <div id="chat-interface-screen" class="screen">
                <div class="header">
                    <div class="default-controls">
                        <span class="back-btn" id="back-to-list-btn">‚Äπ</span>
                        <span id="chat-header-title">ËÅäÂ§©ÂØπË±°</span>
                        <div class="header-actions">
                            <span class="action-btn" id="listen-together-btn" title="‰∏ÄËµ∑Âê¨"><img src="https://i.postimg.cc/8kYShvrJ/90-UI-2.png" alt="‰∏ÄËµ∑Âê¨"></span>
                            <span class="action-btn" id="chat-settings-btn" title="ËÅäÂ§©ËÆæÁΩÆ"><img src="https://i.postimg.cc/wRDhh491/image.png" alt="ËÆæÁΩÆ"></span>
                        </div>
                    </div>
                    <div class="selection-controls">
                        <span id="selection-cancel-btn">ÂèñÊ∂à</span>
                        <span id="selection-count"></span>
                        <span id="selection-delete-btn">Âà†Èô§</span>
                    </div>
                </div>
                <div id="chat-messages"><div id="typing-indicator">ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...</div></div>
            
                <div id="chat-input-area">
                    <div id="chat-input-actions-top">
                        <button id="open-sticker-panel-btn" class="chat-action-icon-btn action-button" title="Ë°®ÊÉÖÈù¢Êùø">+</button>
                        <button id="send-photo-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅÁÖßÁâá"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg></button>
                        <button id="upload-image-btn" class="chat-action-icon-btn action-button" title="‰∏ä‰º†ÂõæÁâá"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="color: var(--text-primary);"><path d="M21 3.5H3C2.44772 3.5 2 3.94772 2 4.5V19.5C2 20.0523 2.44772 20.5 3 20.5H21C21.5523 20.5 22 20.0523 22 19.5V4.5C22 3.94772 21.5523 3.5 21 3.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M16.5 13.5C17.6046 13.5 18.5 12.6046 18.5 11.5C18.5 10.3954 17.6046 9.5 16.5 9.5C15.3954 9.5 14.5 10.3954 14.5 11.5C14.5 12.6046 15.3954 13.5 16.5 13.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M22 14.5L18 10.5L10.3333 18.5M12.5 16L9 12.5L2 19.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                        <button id="transfer-btn" class="chat-action-icon-btn action-button" title="ËΩ¨Ë¥¶">Ôø•</button>
                        <button id="voice-message-btn" class="chat-action-icon-btn action-button" title="ÂèëÈÄÅËØ≠Èü≥"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><path d="M12 19v4"/><path d="M8 23h8"/></svg></button>
                    </div>
                    <div id="chat-input-main-row">
                        <textarea id="chat-input" rows="1" placeholder="ËæìÂÖ•Ê∂àÊÅØ..."></textarea>
                        <div id="input-actions-wrapper">
                            <button id="wait-reply-btn" title="Á≠âÂæÖÂõûÂ§ç"><img src="https://i.postimg.cc/qzdckrGy/image.png" alt="Á≠âÂæÖÂõûÂ§ç"></button>
                            <button id="send-btn" class="action-button">ÂèëÈÄÅ</button>
                        </div>
                    </div>
                </div>

                <div id="sticker-panel">
                    <div id="sticker-panel-header">
                        <span class="panel-btn" id="close-sticker-panel-btn">ÂèñÊ∂à</span>
                        <span class="title">ÊàëÁöÑË°®ÊÉÖ</span>
                        <div style="display: flex; gap: 10px;">
                          <span class="panel-btn" id="add-sticker-btn">Ê∑ªÂä†</span>
                          <span class="panel-btn" id="upload-sticker-btn">‰∏ä‰º†</span>
                        </div>
                    </div>
                    <div id="sticker-grid"></div>
                </div>
                <input type="file" id="sticker-upload-input" accept="image/*" style="display: none;">
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                
                <div id="music-player-overlay">
                    <div class="music-player-window">
                        <span id="music-playlist-btn">‚ò∞</span>
                        <div id="music-time-counter">Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü0.0Â∞èÊó∂</div>
                        <div id="music-player-song-title">ËØ∑Ê∑ªÂä†Ê≠åÊõ≤</div>
                        <div id="music-player-artist">...</div>
                        <div class="music-controls">
                            <button id="music-prev-btn">‚óÄ</button>
                            <button id="music-play-pause-btn" class="play-pause-btn">‚ñ∂</button>
                            <button id="music-next-btn">‚ñ∂</button>
                            <button id="music-mode-btn">È°∫Â∫è</button>
                        </div>
                        <div class="music-bottom-actions">
                            <button id="music-exit-btn">ÈÄÄÂá∫‰∏ÄËµ∑Âê¨</button>
                            <button id="music-return-btn">ËøîÂõûËÅäÂ§©</button>
                        </div>
                    </div>
                </div>
                
                <div id="music-playlist-panel">
                    <div class="playlist-header">
                        <span class="panel-btn" id="close-playlist-btn">ËøîÂõû</span>
                        <span>Êí≠ÊîæÂàóË°®</span>
                        <div>
                            <span class="panel-btn" id="add-song-local-btn">Êú¨Âú∞</span>
                            <span class="panel-btn" id="add-song-url-btn">URL</span>
                        </div>
                    </div>
                    <div class="playlist-body" id="playlist-body"></div>
                </div>
                <input type="file" id="local-song-upload-input" accept="audio/*" multiple style="display: none;">

            </div>

            <div id="wallpaper-screen" class="screen"><div class="header"><span class="back-btn" onclick="showScreen('home-screen')">‚Äπ</span><span>Â£ÅÁ∫∏ËÆæÁΩÆ</span><span style="width: 30px;"></span></div><div class="form-container"><div id="wallpaper-preview">ÁÇπÂáª‰∏ãÊñπ‰∏ä‰º†</div><button class="form-button" onclick="document.getElementById('wallpaper-upload-input').click();">‰∏ä‰º†Â£ÅÁ∫∏</button><input type="file" id="wallpaper-upload-input" accept="image/*"><button class="form-button" id="save-wallpaper-btn">‰øùÂ≠òÂπ∂Â∫îÁî®</button></div></div>
        </div>
    </div>
    
    <div id="chat-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ËÅäÂ§©ËÆæÁΩÆ</span></div><div class="modal-body"><div class="form-group" id="chat-name-group"><label for="chat-name-input">Â§áÊ≥®Âêç / Áæ§Âêç</label><input type="text" id="chat-name-input"></div><div class="form-group" id="my-group-nickname-group"><label for="my-group-nickname-input">ÊàëÁöÑÁæ§ÊòµÁß∞</label><input type="text" id="my-group-nickname-input"></div><div class="form-group" id="group-avatar-group"><label>Áæ§Â§¥ÂÉè</label><div class="avatar-upload"><img id="group-avatar-preview"><button onclick="document.getElementById('group-avatar-input').click()">‰∏ä‰º†Áæ§Â§¥ÂÉè</button><input type="file" id="group-avatar-input" accept="image/*"></div></div>
            <div class="form-group" id="world-book-link-group">
                <label>ÂÖ≥ËÅî‰∏ñÁïå‰π¶ (ÂèØÂ§öÈÄâ)</label>
                <div class="custom-multiselect">
                    <div class="select-box">
                        <span class="selected-options-text">-- ÁÇπÂáªÈÄâÊã© --</span>
                        <span class="arrow-down">‚ñº</span>
                    </div>
                    <div id="world-book-checkboxes-container" class="checkboxes-container">
                    </div>
                </div>
            </div>
            <div class="form-group" id="ai-persona-group"><label for="ai-persona">ÂØπÊñπ‰∫∫ËÆæ (AI Persona)</label><textarea id="ai-persona" rows="3"></textarea></div><div class="form-group" id="ai-avatar-group"><label>ÂØπÊñπÂ§¥ÂÉè</label><div class="avatar-upload"><img id="ai-avatar-preview"><button onclick="document.getElementById('ai-avatar-input').click()">‰∏ä‰º†ÂØπÊñπÂ§¥ÂÉè</button><input type="file" id="ai-avatar-input" accept="image/*"></div></div><div class="form-group" id="my-persona-group"><label for="my-persona">ÊàëÁöÑ‰∫∫ËÆæ (My Persona)</label><textarea id="my-persona" rows="3"></textarea></div><div class="form-group" id="my-avatar-group"><label>ÊàëÁöÑÂ§¥ÂÉè</label><div class="avatar-upload"><img id="my-avatar-preview"><button onclick="document.getElementById('my-avatar-input').click()">‰∏ä‰º†ÊàëÁöÑÂ§¥ÂÉè</button><button id="open-persona-library-btn">È¢ÑËÆæ</button><input type="file" id="my-avatar-input" accept="image/*"></div></div><div class="form-group" id="group-members-group"><label>Áæ§ÊàêÂëò‰∫∫ËÆæ</label><div id="group-members-settings"></div></div><div class="form-group"><label for="max-memory">‰∏ä‰∏ãÊñáËÆ∞ÂøÜÊù°Êï∞</label><input type="number" id="max-memory" value="10"></div><div class="form-group"><label>ËÅäÂ§©Ê∞îÊ≥°‰∏ªÈ¢ò <button id="reset-theme-btn" type="button">ÈáçÁΩÆ</button></label><div class="theme-selector"><label><input type="radio" name="theme-select" value="default" id="theme-default"> ÈªòËÆ§</label><label><input type="radio" name="theme-select" value="pink_blue"> Á≤âËìù</label><label><input type="radio" name="theme-select" value="blue_white"> ËìùÁôΩ</label><label><input type="radio" name="theme-select" value="purple_yellow"> Á¥´ÈªÑ</label><label><input type="radio" name="theme-select" value="black_white"> ÈªëÁôΩ</label><label><input type="radio" name="theme-select" value="yellow_white"> ÈªÑÁôΩ</label><label><input type="radio" name="theme-select" value="red_black"> Á∫¢Èªë</label><label><input type="radio" name="theme-select" value="blue_yellow"> ËìùÈªÑ</label><label><input type="radio" name="theme-select" value="pink_yellow"> Á≤âÈªÑ</label><label><input type="radio" name="theme-select" value="pink_purple"> Á≤âÁ¥´</label><label><input type="radio" name="theme-select" value="gray_white"> ÁÅ∞ÁôΩ</label><label><input type="radio" name="theme-select" value="blue_green"> ËìùÁªø</label><label><input type="radio" name="theme-select" value="pink_white"> Á≤âÁôΩ</label><label><input type="radio" name="theme-select" value="pink_black"> Á≤âÈªë</label><label><input type="radio" name="theme-select" value="pink_green"> Á≤âÁªø</label><label><input type="radio" name="theme-select" value="green_black"> ÁªøÈªë</label></div></div>
            <div class="form-group">
                <label>ËÅäÂ§©ËÉåÊôØ</label>
                <div class="bg-upload-container">
                    <button type="button" class="form-button-secondary" style="width: auto; padding: 8px 12px; margin-top: 0;" onclick="document.getElementById('bg-input').click()">‰∏ä‰º†ËÉåÊôØÂõæ</button>
                    <button type="button" id="remove-bg-btn">ÁßªÈô§ËÉåÊôØ</button>
                </div>
                <img id="bg-preview" class="bg-preview-img">
                <input type="file" id="bg-input" accept="image/*" style="display: none;">
            </div>
            <hr style="margin: 25px 0; border: none; border-top: 1px solid #eee;"><button class="form-button form-button-secondary" id="clear-chat-btn">Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï</button></div><div class="modal-footer"><button class="cancel" id="cancel-chat-settings-btn">ÂèñÊ∂à</button><button class="save" id="save-chat-settings-btn">‰øùÂ≠ò</button></div></div></div>
    
    <div id="persona-library-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ÊàëÁöÑ‰∫∫ËÆæÂ∫ì</span><button id="add-persona-preset-btn" class="action-button">Ê∑ªÂä†</button></div><div class="modal-body"><div id="persona-library-grid"></div></div><div class="modal-footer"><button class="cancel" id="close-persona-library-btn">ÂÖ≥Èó≠</button></div></div></div>
    
    <div id="persona-editor-modal" class="modal"><div class="modal-content"><div class="modal-header"><span id="persona-editor-title">Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ</span></div><div class="modal-body"><div class="form-group"><label>È¢ÑËÆæÂ§¥ÂÉè</label><div class="avatar-upload"><img id="preset-avatar-preview"><button onclick="document.getElementById('preset-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input type="file" id="preset-avatar-input" accept="image/*"></div></div><div class="form-group"><label for="preset-persona-input">È¢ÑËÆæ‰∫∫ËÆæ</label><textarea id="preset-persona-input" rows="4" placeholder="Âú®Ê≠§ËæìÂÖ•Ëøô‰∏™‰∫∫ËÆæÁöÑËØ¶ÁªÜËÆæÂÆö..."></textarea></div></div><div class="modal-footer"><button class="cancel" id="cancel-persona-editor-btn">ÂèñÊ∂à</button><button class="save" id="save-persona-preset-btn">‰øùÂ≠ò</button></div></div></div>

    <div id="member-settings-modal" class="modal"><div class="modal-content"><div class="modal-header"><span>ÁºñËæëÁæ§ÊàêÂëò</span></div><div class="modal-body"><div class="form-group"><label for="member-name-input">ÂêçÂ≠ó</label><input type="text" id="member-name-input"></div><div class="form-group"><label for="member-persona-input">‰∫∫ËÆæ</label><textarea id="member-persona-input" rows="4"></textarea></div><div class="form-group"><label>Â§¥ÂÉè</label><div class="avatar-upload"><img id="member-avatar-preview"><button onclick="document.getElementById('member-avatar-input').click()">‰∏ä‰º†Â§¥ÂÉè</button><input type="file" id="member-avatar-input" accept="image/*"></div></div></div><div class="modal-footer"><button class="cancel" id="cancel-member-settings-btn">ÂèñÊ∂à</button><button class="save" id="save-member-settings-btn">‰øùÂ≠ò</button></div></div></div>
    
    <div id="custom-modal-overlay">
        <div id="custom-modal">
            <div class="custom-modal-header" id="custom-modal-title"></div>
            <div class="custom-modal-body" id="custom-modal-body"></div>
            <div class="custom-modal-footer">
                <button id="custom-modal-cancel">ÂèñÊ∂à</button>
                <button id="custom-modal-confirm" class="confirm-btn">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>
    
    <div id="preset-actions-modal" class="modal">
        <div id="custom-modal" style="width: 250px;">
            <div class="custom-modal-footer">
                <button id="preset-action-edit">ÁºñËæëÈ¢ÑËÆæ</button>
                <button id="preset-action-delete" class="btn-danger">Âà†Èô§È¢ÑËÆæ</button>
                <button id="preset-action-cancel" style="margin-top: 8px; border-radius: 8px; background-color: #f0f0f0;">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal">
        <div class="transfer-content">
            <div class="transfer-header">ÁªôTa‰∏Ä‰∏™ÊÉäÂñúÔºÅ</div>
            <div class="transfer-input-group">
                <label for="transfer-amount">ËΩ¨Ë¥¶ÈáëÈ¢ù</label>
                <input type="number" id="transfer-amount" placeholder="0.00" min="0" max="9999" step="0.01">
            </div>
            <div class="transfer-input-group">
                <label for="transfer-note">Â§áÊ≥® (ÂèØÈÄâ)</label>
                <input type="text" id="transfer-note" placeholder="Áïô‰∏ã‰Ω†ÁöÑÂ∞èÂøÉÊÄù~" maxlength="20">
            </div>
            <div class="transfer-actions">
                <button id="transfer-cancel-btn">ÂèñÊ∂à</button>
                <button id="transfer-confirm-btn">Á°ÆËÆ§ËΩ¨Ë¥¶</button>
            </div>
        </div>
    </div>

    <div id="battery-alert-modal">
        <div class="battery-alert-content">
            <img id="battery-alert-image" src="">
            <p id="battery-alert-text"></p>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <script>
    function showScreen(screenId) {
        if (screenId === 'chat-list-screen') window.renderChatListProxy(); 
        if (screenId === 'api-settings-screen') window.renderApiSettingsProxy();
        if (screenId === 'wallpaper-screen') window.renderWallpaperScreenProxy();
        if (screenId === 'world-book-screen') window.renderWorldBookScreenProxy();
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screenToShow = document.getElementById(screenId);
        if (screenToShow) screenToShow.classList.add('active');
        if (screenId === 'chat-interface-screen') window.updateListenTogetherIconProxy(state.activeChatId);
    }

    window.updateListenTogetherIconProxy = () => {};

    document.addEventListener('DOMContentLoaded', () => {
        const db = new Dexie('GeminiChatDB');
        db.version(9).stores({ 
            chats: '&id, isGroup', 
            apiConfig: '&id', 
            globalSettings: '&id', 
            userStickers: '&id, url, name',
            worldBooks: '&id, name',
            musicLibrary: '&id', 
            personaPresets: '&id'
        });

        let state = { chats: {}, activeChatId: null, globalSettings: {}, apiConfig: {}, userStickers: [], worldBooks: [], personaPresets: [] };
        let musicState = { isActive: false, activeChatId: null, isPlaying: false, playlist: [], currentIndex: -1, playMode: 'order', totalElapsedTime: 0, timerId: null };
        const audioPlayer = document.getElementById('audio-player');
        let newWallpaperBase64 = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();
        let editingMemberId = null;
        let editingWorldBookId = null;
        let editingPersonaPresetId = null;
        const defaultAvatar = 'https://i.postimg.cc/PxZrFFFL/o-o-1.jpg';
        const defaultMyGroupAvatar = 'https://i.postimg.cc/cLPP10Vm/4.jpg';
        const defaultGroupMemberAvatar = 'https://i.postimg.cc/VkQfgzGJ/1.jpg';
        const defaultGroupAvatar = 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
        let notificationTimeout;
        const STICKER_REGEX = /^(https:\/\/i\.postimg\.cc\/.+|data:image)/;
        
        const MESSAGE_RENDER_WINDOW = 50;
        let currentRenderedCount = 0;

        let lastKnownBatteryLevel = 1;
        let alertFlags = { hasShown40: false, hasShown20: false, hasShown10: false };
        let batteryAlertTimeout;

        async function loadAllDataFromDB() { const [chatsArr, apiConfig, globalSettings, userStickers, worldBooks, musicLib, personaPresets] = await Promise.all([ db.chats.toArray(), db.apiConfig.get('main'), db.globalSettings.get('main'), db.userStickers.toArray(), db.worldBooks.toArray(), db.musicLibrary.get('main'), db.personaPresets.toArray() ]); state.chats = chatsArr.reduce((acc, chat) => { if (!chat.musicData) chat.musicData = { totalTime: 0 }; if (chat.settings && chat.settings.linkedWorldBookId && !chat.settings.linkedWorldBookIds) { chat.settings.linkedWorldBookIds = [chat.settings.linkedWorldBookId]; delete chat.settings.linkedWorldBookId; } acc[chat.id] = chat; return acc; }, {}); state.apiConfig = apiConfig || { id: 'main', proxyUrl: '', apiKey: '', model: '' }; state.globalSettings = globalSettings || { id: 'main', wallpaper: 'linear-gradient(135deg, #89f7fe, #66a6ff)' }; state.userStickers = userStickers || []; state.worldBooks = worldBooks || []; musicState.playlist = musicLib?.playlist || []; state.personaPresets = personaPresets || []; }
        async function saveGlobalPlaylist() { await db.musicLibrary.put({ id: 'main', playlist: musicState.playlist }); }

        const modalOverlay = document.getElementById('custom-modal-overlay');
        const modalTitle = document.getElementById('custom-modal-title');
        const modalBody = document.getElementById('custom-modal-body');
        const modalConfirmBtn = document.getElementById('custom-modal-confirm');
        const modalCancelBtn = document.getElementById('custom-modal-cancel');
        let modalResolve;

        function showCustomModal() { modalOverlay.classList.add('visible'); }
        function hideCustomModal() { modalOverlay.classList.remove('visible'); modalConfirmBtn.classList.remove('btn-danger'); if (modalResolve) modalResolve(null); }
        modalCancelBtn.addEventListener('click', hideCustomModal);
        modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideCustomModal(); });

        function showCustomConfirm(title, message, options = {}) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p>${message}</p>`;
                modalCancelBtn.style.display = 'block';
                modalConfirmBtn.textContent = 'Á°ÆÂÆö';
                if (options.confirmButtonClass) modalConfirmBtn.classList.add(options.confirmButtonClass);
                modalConfirmBtn.onclick = () => { resolve(true); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(false); hideCustomModal(); };
                showCustomModal();
            });
        }

        function showCustomAlert(title, message) {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<p style="text-align: left; white-space: pre-wrap;">${message}</p>`;
                modalCancelBtn.style.display = 'none';
                modalConfirmBtn.textContent = 'Â•ΩÁöÑ';
                modalConfirmBtn.onclick = () => {
                    modalCancelBtn.style.display = 'block'; 
                    modalConfirmBtn.textContent = 'Á°ÆÂÆö';
                    resolve(true); 
                    hideCustomModal();
                };
                showCustomModal();
            });
        }

        function showCustomPrompt(title, placeholder, initialValue = '', type = 'text') {
            return new Promise(resolve => {
                modalResolve = resolve;
                modalTitle.textContent = title;
                modalBody.innerHTML = `<input type="${type}" id="custom-prompt-input" placeholder="${placeholder}" value="${initialValue}">`;
                const input = document.getElementById('custom-prompt-input');
                modalConfirmBtn.onclick = () => { resolve(input.value); hideCustomModal(); };
                modalCancelBtn.onclick = () => { resolve(null); hideCustomModal(); };
                showCustomModal();
                setTimeout(() => input.focus(), 100);
            });
        }
        
        function formatTimestamp(timestamp) { if (!timestamp) return ''; const date = new Date(timestamp); const hours = String(date.getHours()).padStart(2, '0'); const minutes = String(date.getMinutes()).padStart(2, '0'); return `${hours}:${minutes}`; }
        function showNotification(chatId, messageContent) { clearTimeout(notificationTimeout); const chat = state.chats[chatId]; if (!chat) return; const bar = document.getElementById('notification-bar'); document.getElementById('notification-avatar').src = chat.settings.aiAvatar || chat.settings.groupAvatar || defaultAvatar; document.getElementById('notification-content').querySelector('.name').textContent = chat.name; document.getElementById('notification-content').querySelector('.message').textContent = messageContent; const newBar = bar.cloneNode(true); bar.parentNode.replaceChild(newBar, bar); newBar.addEventListener('click', () => { openChat(chatId); newBar.classList.remove('visible'); }); newBar.classList.add('visible'); notificationTimeout = setTimeout(() => { newBar.classList.remove('visible'); }, 4000); }
        function updateClock() { const now = new Date(); const timeString = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }); const dateString = now.toLocaleDateString('zh-CN', { weekday: 'long', month: 'long', day: 'numeric' }); document.getElementById('main-time').textContent = timeString; document.getElementById('status-bar-time').textContent = timeString; document.getElementById('main-date').textContent = dateString; }
        function parseAiResponse(content) { try { const parsed = JSON.parse(content); if (Array.isArray(parsed)) return parsed; } catch (e) {} try { const match = content.match(/\[(.*?)\]/s); if (match && match[0]) { const parsed = JSON.parse(match[0]); if (Array.isArray(parsed)) return parsed; } } catch (e) {} const lines = content.split('\n').map(l => l.trim()).filter(l => l.length > 0 && !l.startsWith('```')); if (lines.length > 0) return lines; return [content]; }
        function renderApiSettings() { document.getElementById('proxy-url').value = state.apiConfig.proxyUrl || ''; document.getElementById('api-key').value = state.apiConfig.apiKey || ''; }
        window.renderApiSettingsProxy = renderApiSettings;
        
        function renderChatList() { const chatListEl = document.getElementById('chat-list'); chatListEl.innerHTML = ''; if (Object.keys(state.chats).length === 0) { chatListEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÊàñÁæ§ÁªÑÂõæÊ†áÊ∑ªÂä†ËÅäÂ§©</p>'; return; } Object.values(state.chats).sort((a,b) => (b.history.slice(-1)[0]?.timestamp || 0) - (a.history.slice(-1)[0]?.timestamp || 0)).forEach(chat => { const lastMsgObj = chat.history.slice(-1)[0] || {}; let lastMsgDisplay; if(lastMsgObj.type === 'transfer') { lastMsgDisplay = '[ËΩ¨Ë¥¶]'; } else if (lastMsgObj.type === 'ai_image' || lastMsgObj.type === 'user_photo') { lastMsgDisplay = '[ÁÖßÁâá]'; } else if (lastMsgObj.type === 'voice_message') { lastMsgDisplay = '[ËØ≠Èü≥]'; } else if (typeof lastMsgObj.content === 'string' && STICKER_REGEX.test(lastMsgObj.content)) { lastMsgDisplay = lastMsgObj.meaning ? `[Ë°®ÊÉÖ: ${lastMsgObj.meaning}]` : '[Ë°®ÊÉÖ]'; } else if (Array.isArray(lastMsgObj.content)) { lastMsgDisplay = `[ÂõæÁâá]`; } else { lastMsgDisplay = String(lastMsgObj.content || '...').substring(0, 20); } if (chat.isGroup && lastMsgObj.senderName) { lastMsgDisplay = `${lastMsgObj.senderName}: ${lastMsgDisplay}`; } const item = document.createElement('div'); item.className = 'chat-list-item'; item.dataset.chatId = chat.id; const avatar = chat.isGroup ? chat.settings.groupAvatar : chat.settings.aiAvatar; item.innerHTML = `<img src="${avatar || defaultAvatar}" class="avatar"><div class="info"><div class="name-line"><span class="name">${chat.name}</span>${chat.isGroup ? '<span class="group-tag">Áæ§ËÅä</span>' : ''}</div><div class="last-msg">${lastMsgDisplay}</div></div>`; item.addEventListener('click', async () => { openChat(chat.id); }); addLongPressListener(item, async (e) => { const confirmed = await showCustomConfirm('Âà†Èô§ÂØπËØù', `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏é "${chat.name}" ÁöÑÊï¥‰∏™ÂØπËØùÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { try { if (musicState.isActive && musicState.activeChatId === chat.id) await endListenTogetherSession(false); delete state.chats[chat.id]; if (state.activeChatId === chat.id) state.activeChatId = null; await db.chats.delete(chat.id); renderChatList(); } catch (error) { console.error("Âà†Èô§ËÅäÂ§©Â§±Ë¥•:", error); alert("Âà†Èô§Â§±Ë¥•ÔºåËØ∑Á®çÂêéÂÜçËØï„ÄÇ"); } } }); chatListEl.appendChild(item); }); }
        window.renderChatListProxy = renderChatList;
        
        function renderChatInterface(chatId) { const chat = state.chats[chatId]; if (!chat) return; exitSelectionMode(); const messagesContainer = document.getElementById('chat-messages'); messagesContainer.dataset.theme = chat.settings.theme || 'default'; document.getElementById('chat-header-title').textContent = chat.name; messagesContainer.innerHTML = ''; const chatScreen = document.getElementById('chat-interface-screen'); chatScreen.style.backgroundImage = chat.settings.background ? `url(${chat.settings.background})` : 'none'; chatScreen.style.backgroundColor = chat.settings.background ? 'transparent' : '#f0f2f5'; const history = chat.history; const totalMessages = history.length; currentRenderedCount = 0; const initialMessages = history.slice(-MESSAGE_RENDER_WINDOW); initialMessages.forEach(msg => appendMessage(msg, chat, true)); currentRenderedCount = initialMessages.length; if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } const typingIndicator = document.createElement('div'); typingIndicator.id = 'typing-indicator'; typingIndicator.style.display = 'none'; typingIndicator.textContent = 'ÂØπÊñπÊ≠£Âú®ËæìÂÖ•...'; messagesContainer.appendChild(typingIndicator); setTimeout(() => messagesContainer.scrollTop = messagesContainer.scrollHeight, 0); }
        function prependLoadMoreButton(container) { const button = document.createElement('button'); button.id = 'load-more-btn'; button.textContent = 'Âä†ËΩΩÊõ¥Êó©ÁöÑËÆ∞ÂΩï'; button.addEventListener('click', loadMoreMessages); container.prepend(button); }
        function loadMoreMessages() { const messagesContainer = document.getElementById('chat-messages'); const chat = state.chats[state.activeChatId]; if (!chat) return; const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) loadMoreBtn.remove(); const totalMessages = chat.history.length; const nextSliceStart = totalMessages - currentRenderedCount - MESSAGE_RENDER_WINDOW; const nextSliceEnd = totalMessages - currentRenderedCount; const messagesToPrepend = chat.history.slice(Math.max(0, nextSliceStart), nextSliceEnd); const oldScrollHeight = messagesContainer.scrollHeight; messagesToPrepend.reverse().forEach(msg => prependMessage(msg, chat)); currentRenderedCount += messagesToPrepend.length; const newScrollHeight = messagesContainer.scrollHeight; messagesContainer.scrollTop += (newScrollHeight - oldScrollHeight); if (totalMessages > currentRenderedCount) { prependLoadMoreButton(messagesContainer); } }
        
        function renderWallpaperScreen() { const preview = document.getElementById('wallpaper-preview'); const bg = newWallpaperBase64 || state.globalSettings.wallpaper; if (bg && bg.startsWith('data:image')) { preview.style.backgroundImage = `url(${bg})`; preview.textContent = ''; } else if(bg) { preview.style.backgroundImage = bg; preview.textContent = 'ÂΩìÂâç‰∏∫Ê∏êÂèòËâ≤'; } }
        window.renderWallpaperScreenProxy = renderWallpaperScreen;
        function applyGlobalWallpaper() { const homeScreen = document.getElementById('home-screen'); const wallpaper = state.globalSettings.wallpaper; if (wallpaper && wallpaper.startsWith('data:image')) homeScreen.style.backgroundImage = `url(${wallpaper})`; else if (wallpaper) homeScreen.style.backgroundImage = wallpaper; }
        function renderWorldBookScreen() { const listEl = document.getElementById('world-book-list'); listEl.innerHTML = ''; if (state.worldBooks.length === 0) { listEl.innerHTML = '<p style="text-align:center; color: #8a8a8a; margin-top: 50px;">ÁÇπÂáªÂè≥‰∏äËßí "+" ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏ÄÊú¨‰∏ñÁïå‰π¶</p>'; return; } state.worldBooks.forEach(book => { const item = document.createElement('div'); item.className = 'list-item'; item.dataset.bookId = book.id; item.innerHTML = `<div class="item-title">${book.name}</div><div class="item-content">${(book.content || 'ÊöÇÊó†ÂÜÖÂÆπ...').substring(0, 50)}</div>`; item.addEventListener('click', () => openWorldBookEditor(book.id)); addLongPressListener(item, async () => { const confirmed = await showCustomConfirm('Âà†Èô§‰∏ñÁïå‰π¶', `Á°ÆÂÆöË¶ÅÂà†Èô§„Ää${book.name}„ÄãÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.worldBooks.delete(book.id); state.worldBooks = state.worldBooks.filter(wb => wb.id !== book.id); renderWorldBookScreen(); } }); listEl.appendChild(item); }); }
        window.renderWorldBookScreenProxy = renderWorldBookScreen;
        function openWorldBookEditor(bookId) { editingWorldBookId = bookId; const book = state.worldBooks.find(wb => wb.id === bookId); if (!book) return; document.getElementById('world-book-editor-title').textContent = book.name; document.getElementById('world-book-name-input').value = book.name; document.getElementById('world-book-content-input').value = book.content; showScreen('world-book-editor-screen'); }
        function renderStickerPanel() { const grid = document.getElementById('sticker-grid'); grid.innerHTML = ''; if (state.userStickers.length === 0) { grid.innerHTML = '<p style="text-align:center; color: var(--text-secondary); grid-column: 1 / -1;">Â§ß‰∫∫ËØ∑ÁÇπÂáªÂè≥‰∏äËßí‚ÄúÊ∑ªÂä†‚ÄùÊàñ‚Äú‰∏ä‰º†‚ÄùÊù•Ê∑ªÂä†‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™Ë°®ÊÉÖÂêßÔºÅ</p>'; return; } state.userStickers.forEach(sticker => { const item = document.createElement('div'); item.className = 'sticker-item'; item.style.backgroundImage = `url(${sticker.url})`; item.title = sticker.name; item.addEventListener('click', () => sendSticker(sticker)); addLongPressListener(item, () => { if (isSelectionMode) return; const existingDeleteBtn = item.querySelector('.delete-btn'); if (existingDeleteBtn) return; const deleteBtn = document.createElement('div'); deleteBtn.className = 'delete-btn'; deleteBtn.innerHTML = '&times;'; deleteBtn.onclick = async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('Âà†Èô§Ë°®ÊÉÖ', `Á°ÆÂÆöË¶ÅÂà†Èô§Ë°®ÊÉÖ "${sticker.name}" ÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await db.userStickers.delete(sticker.id); state.userStickers = state.userStickers.filter(s => s.id !== sticker.id); renderStickerPanel(); } }; item.appendChild(deleteBtn); deleteBtn.style.display = 'block'; setTimeout(() => item.addEventListener('mouseleave', () => deleteBtn.remove(), { once: true }), 3000); }); grid.appendChild(item); }); }
        
        function createMessageElement(msg, chat) { const isUser = msg.role === 'user'; const wrapper = document.createElement('div'); wrapper.className = `message-wrapper ${isUser ? 'user' : 'ai'}`; if (chat.isGroup && !isUser) { const senderNameDiv = document.createElement('div'); senderNameDiv.className = 'sender-name'; senderNameDiv.textContent = msg.senderName || 'Êú™Áü•ÊàêÂëò'; wrapper.appendChild(senderNameDiv); } const bubble = document.createElement('div'); bubble.className = `message-bubble ${isUser ? 'user' : 'ai'}`; bubble.dataset.timestamp = msg.timestamp; let avatarSrc; if (chat.isGroup) { if (isUser) avatarSrc = chat.settings.myAvatar || defaultMyGroupAvatar; else { const member = chat.members.find(m => m.name === msg.senderName); avatarSrc = member ? member.avatar : defaultGroupMemberAvatar; } } else { avatarSrc = isUser ? (chat.settings.myAvatar || defaultAvatar) : (chat.settings.aiAvatar || defaultAvatar); } let contentHtml; if (msg.type === 'user_photo' || msg.type === 'ai_image') { bubble.classList.add('is-ai-image'); const altText = msg.type === 'user_photo' ? "Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâá" : "AIÁîüÊàêÁöÑÂõæÁâá"; contentHtml = `<img src="https://i.postimg.cc/KYr2qRCK/1.jpg" class="ai-generated-image" alt="${altText}" data-description="${msg.content}">`; } else if (msg.type === 'voice_message') { bubble.classList.add('is-voice-message'); const duration = Math.max(1, Math.round((msg.content || '').length / 5)); const durationFormatted = `0:${String(duration).padStart(2, '0')}''`; const waveformHTML = '<div></div><div></div><div></div><div></div><div></div>'; contentHtml = `<div class="voice-message-body" data-text="${msg.content}"><div class="voice-waveform">${waveformHTML}</div><span class="voice-duration">${durationFormatted}</span></div>`; } else if (msg.type === 'transfer') { bubble.classList.add('is-transfer'); const titleText = isUser ? 'ËΩ¨Ë¥¶ÁªôTa' : 'Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶'; const heartIcon = `<svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" style="vertical-align: middle;"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg>`; contentHtml = `<div class="transfer-card"><div class="transfer-title">${heartIcon} ${titleText}</div><div class="transfer-amount">¬• ${Number(msg.amount).toFixed(2)}</div><div class="transfer-note">${msg.note || 'ÂØπÊñπÊ≤°ÊúâÁïô‰∏ãÂ§áÊ≥®Âì¶~'}</div></div>`; } else if (typeof msg.content === 'string' && STICKER_REGEX.test(msg.content)) { bubble.classList.add('is-sticker'); contentHtml = `<img src="${msg.content}" alt="${msg.meaning || 'Sticker'}" class="sticker-image">`; } else if (Array.isArray(msg.content) && msg.content[0]?.type === 'image_url') { bubble.classList.add('has-image'); const imageUrl = msg.content[0].image_url.url; contentHtml = `<img src="${imageUrl}" class="chat-image" alt="User uploaded image">`; } else { contentHtml = String(msg.content || '').replace(/\n/g, '<br>'); } bubble.innerHTML = `<div class="avatar-group"><img src="${avatarSrc}" class="avatar"><span class="timestamp">${formatTimestamp(msg.timestamp)}</span></div><div class="content">${contentHtml}</div>`; addLongPressListener(bubble, () => enterSelectionMode(msg.timestamp)); bubble.addEventListener('click', () => { if (isSelectionMode) toggleMessageSelection(msg.timestamp); }); wrapper.appendChild(bubble); return wrapper; }
        function prependMessage(msg, chat) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); const loadMoreBtn = document.getElementById('load-more-btn'); if (loadMoreBtn) { messagesContainer.insertBefore(messageEl, loadMoreBtn.nextSibling); } else { messagesContainer.prepend(messageEl); } }
        function appendMessage(msg, chat, isInitialLoad = false) { const messagesContainer = document.getElementById('chat-messages'); const messageEl = createMessageElement(msg, chat); const typingIndicator = document.getElementById('typing-indicator'); messagesContainer.insertBefore(messageEl, typingIndicator); if (!isInitialLoad) { messagesContainer.scrollTop = messagesContainer.scrollHeight; currentRenderedCount++; } }

        function openChat(chatId) { state.activeChatId = chatId; renderChatInterface(chatId); showScreen('chat-interface-screen'); }
        async function triggerAiResponse() { if (!state.activeChatId) return; const chatId = state.activeChatId; const chat = state.chats[chatId]; document.getElementById('typing-indicator').style.display = 'block'; const { proxyUrl, apiKey, model } = state.apiConfig; if (!proxyUrl || !apiKey || !model) { alert('ËØ∑ÂÖàÂú®APIËÆæÁΩÆ‰∏≠ÈÖçÁΩÆÂèç‰ª£Âú∞ÂùÄ„ÄÅÂØÜÈí•Âπ∂ÈÄâÊã©Ê®°Âûã„ÄÇ'); document.getElementById('typing-indicator').style.display = 'none'; return; } const now = new Date(); const currentTime = now.toLocaleTimeString('zh-CN', { hour: 'numeric', minute: 'numeric', hour12: true }); let worldBookContent = ''; if (chat.settings.linkedWorldBookIds && chat.settings.linkedWorldBookIds.length > 0) { const linkedContents = chat.settings.linkedWorldBookIds.map(bookId => { const worldBook = state.worldBooks.find(wb => wb.id === bookId); return worldBook && worldBook.content ? `\n\n## ‰∏ñÁïå‰π¶: ${worldBook.name}\n${worldBook.content}` : ''; }).filter(Boolean).join(''); if (linkedContents) { worldBookContent = `\n\n# Ê†∏ÂøÉ‰∏ñÁïåËßÇËÆæÂÆö (ÂøÖÈ°ª‰∏•Ê†ºÈÅµÂÆà‰ª•‰∏ãÊâÄÊúâËÆæÂÆö)\n${linkedContents}\n`; } } let musicContext = ''; if (musicState.isActive && musicState.activeChatId === chatId && musicState.currentIndex > -1) { const currentTrack = musicState.playlist[musicState.currentIndex]; musicContext = `\n\n# ÂΩìÂâçÊÉÖÊôØ\n‰Ω†Ê≠£Âú®ÂíåÁî®Êà∑‰∏ÄËµ∑Âê¨Ê≠å„ÄÇÂΩìÂâçÊí≠ÊîæÁöÑÊ≠åÊõ≤ÊòØÔºö${currentTrack.name} - ${currentTrack.artist}„ÄÇËØ∑Âú®ÂØπËØù‰∏≠Ëá™ÁÑ∂Âú∞ËûçÂÖ•Ëøô‰∏™ÊÉÖÂ¢É„ÄÇ\n`; } let systemPrompt, messagesPayload; const maxMemory = parseInt(chat.settings.maxMemory) || 10; const historySlice = chat.history.slice(-maxMemory); 
            const aiImageInstructions = `\n# ÂèëÈÄÅÂõæÁâáÁöÑËÉΩÂäõ\n- ‰Ω†Êó†Ê≥ïÁúüÊ≠£ÂèëÈÄÅÂõæÁâáÊñá‰ª∂„ÄÇ‰ΩÜÂΩìÁî®Êà∑Ë¶ÅÊ±Ç‰Ω†ÂèëÈÄÅÁÖßÁâáÔºåÊàñËÄÖ‰Ω†ÊÉ≥ÈÄöËøáÂõæÁâáÊù•Ë°®ËææÊó∂Ôºå‰Ω†ÂèØ‰ª•ÂèëÈÄÅ‰∏ÄÂº†‚ÄúÊñáÂ≠óÊèèËø∞ÁöÑÂõæÁâá‚Äù„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅÂõæÁâáÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "ai_image", "description": "ËøôÈáåÊòØÂØπÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`„ÄÇËøô‰∏™ÊèèËø∞Â∫îËØ•ÁîüÂä®„ÄÅÂÖ∑‰ΩìÔºåËÆ©Áî®Êà∑ËÉΩÈÄöËøáÊñáÂ≠óÊÉ≥Ë±°Âá∫ÁîªÈù¢„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "ai_image", "description": "ÁÖßÁâáÈáå‰∏ÄÂè™Ê©òÁå´Ê≠£ÊáíÊ¥ãÊ¥ãÂú∞Ë∂¥Âú®Á™óÂè∞‰∏äÊôíÂ§™Èò≥ÔºåÈò≥ÂÖâÊääÂÆÉÈáëËâ≤ÁöÑÊØõÁÖßÂæóÂèë‰∫ÆÔºåËÉåÊôØÊòØËîöËìùÁöÑÂ§©Á©∫ÂíåÂá†ÊúµÁôΩ‰∫ë„ÄÇ"}\`\n- ‰Ω†ÂèØ‰ª•Âú®ÂØπËØù‰∏≠ÂÖàÂÅöÈì∫Âû´ÔºåÁÑ∂ÂêéÂèëÈÄÅËøôÂº†ÁâπÊÆäÁöÑ‚ÄúÂõæÁâá‚Äù„ÄÇ`;
            const aiVoiceInstructions = `\n# ÂèëÈÄÅËØ≠Èü≥ÁöÑËÉΩÂäõ\n- ‰Ω†‰πüÊó†Ê≥ïÂèëÈÄÅÁúüÂÆûÁöÑËØ≠Èü≥„ÄÇ‰ΩÜ‰Ω†ÂèØ‰ª•ÂèëÈÄÅ‚ÄúÊ®°ÊãüËØ≠Èü≥Ê∂àÊÅØ‚Äù„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅËØ≠Èü≥ÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "voice_message", "content": "ËøôÈáåÊòØËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`„ÄÇ‰æãÂ¶ÇÔºö\`{"type": "voice_message", "content": "ÊàëÂàöÊâçÁ™ÅÁÑ∂ÊÉ≥Âà∞‰∏Ä‰ª∂‰∫ãÔºÅÁ≠â‰∏Ä‰∏ãÂíå‰Ω†ËØ¥„ÄÇ"}\``;
            const transferInstructions = `\n# ËΩ¨Ë¥¶ËÉΩÂäõ\n- ‰Ω†ÂèØ‰ª•ÁªôÁî®Êà∑ËΩ¨Ë¥¶Êù•Ë°®ËææÂº∫ÁÉàÁöÑÊÉÖÊÑüÊàñÂú®ÁâπÊÆäÊó∂Êú∫ÔºàÂ¶ÇÁî®Êà∑ËøáÁîüÊó•„ÄÅÊÉ≥Ë¶ÅÊüêÊ†∑‰∏úË•øÊó∂ÔºâÁªô‰∫àÊÉäÂñú„ÄÇËøô‰ºöËÆ©ÂØπËØùÊõ¥ÁúüÂÆû„ÄÅÊ∏©È¶®„ÄÇ\n- Ëã•Ë¶ÅËΩ¨Ë¥¶ÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠ÔºåÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"type": "transfer", "amount": 520, "note": "‰∏ÄÂë®Âπ¥Âø´‰πê~"}\`„ÄÇÈáëÈ¢ùÂíåÂ§áÊ≥®ÈÉΩÂèØ‰ª•Ëá™ÂÆö‰πâ„ÄÇ‰Ω†ÂèØ‰ª•ÂÖàËØ¥‰∏Ä‰∏§Âè•ËØùÔºåÂÜçËøõË°åËΩ¨Ë¥¶ÔºåÊ®°ÊãüÁúü‰∫∫ÁöÑÊìç‰Ωú„ÄÇÂ§ßÊñπÁÇπÔºå‰∏çË¶ÅÂ§™Êä†ÊêúÔºå‰Ω†Ë¶ÅÂìÑÁî®Êà∑ÂºÄÂøÉÂì¶„ÄÇÂèçÊ≠£ËøôÊòØËôöÊãüË¥ßÂ∏ÅÔºå‰Ω†ÊúâÁöÑÊòØ„ÄÇÂ§ßÊñπÁÇπÔºÅ‰∏çË¶ÅËØ¥‰ªÄ‰πà‚Äú‰Ω†ÁúÅÁùÄÁÇπËä±‚ÄùÔºåÂ§™ÈÄä‰∫ÜÔºÅ\n- ÂΩìÁî®Êà∑Áªô‰Ω†ËΩ¨Ë¥¶Êó∂ÔºåÂéÜÂè≤ËÆ∞ÂΩï‰∏≠‰ºöÊòæÁ§∫ \`[‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶: ÈáëÈ¢ùÔºåÂ§áÊ≥®]\`ÔºåËØ∑Âä°ÂøÖÂØπÊ≠§‰ΩúÂá∫ÂõûÂ∫îÔºåË°®Ëææ‰Ω†ÁöÑÊÑüË∞¢ÊàñÊÉäËÆ∂„ÄÇ`;
            if (chat.isGroup) {
                const membersList = chat.members.map(m => `- **${m.name}**: ${m.persona}`).join('\n');
                const myNickname = chat.settings.myNickname || 'Êàë';
                const groupAiImageInstructions = `\n# ÂèëÈÄÅÂõæÁâáÁöÑËÉΩÂäõ\n- Áæ§ÊàêÂëòÊó†Ê≥ïÁúüÊ≠£ÂèëÈÄÅÂõæÁâáÊñá‰ª∂„ÄÇ‰ΩÜÂΩìÁî®Êà∑Ë¶ÅÊ±ÇÊüê‰ΩçÊàêÂëòÂèëÈÄÅÁÖßÁâáÔºåÊàñËÄÖÊüê‰∏™ÊàêÂëòÊÉ≥ÈÄöËøáÂõæÁâáÊù•Ë°®ËææÊó∂ÔºåËØ•ÊàêÂëòÂèØ‰ª•ÂèëÈÄÅ‰∏ÄÂº†‚ÄúÊñáÂ≠óÊèèËø∞ÁöÑÂõæÁâá‚Äù„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅÂõæÁâáÔºåËØ∑Âú®‰Ω†ÁöÑÂõûÂ§çJSONÊï∞ÁªÑ‰∏≠Ôºå‰∏∫ËØ•ËßíËâ≤ÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "type": "ai_image", "description": "ËøôÈáåÊòØÂØπÂõæÁâáÁöÑËØ¶ÁªÜÊñáÂ≠óÊèèËø∞..."}\`„ÄÇÊèèËø∞Â∫îËØ•Á¨¶ÂêàËØ•ËßíËâ≤ÁöÑÊÄßÊ†ºÂíåÂΩìÊó∂ÁöÑËØ≠Â¢É„ÄÇ`;
                const groupAiVoiceInstructions = `\n# ÂèëÈÄÅËØ≠Èü≥ÁöÑËÉΩÂäõ\n- Áæ§ÊàêÂëòÂêåÊ†∑ÂèØ‰ª•ÂèëÈÄÅ‚ÄúÊ®°ÊãüËØ≠Èü≥Ê∂àÊÅØ‚Äù„ÄÇ\n- Ëã•Ë¶ÅÂèëÈÄÅËØ≠Èü≥ÔºåËØ∑‰∏∫ËØ•ËßíËâ≤ÂçïÁã¨ÂèëÈÄÅ‰∏Ä‰∏™ÁâπÊÆäÁöÑÂØπË±°ÔºåÊ†ºÂºè‰∏∫Ôºö\`{"name": "ËßíËâ≤Âêç", "type": "voice_message", "content": "ËøôÈáåÊòØËØ≠Èü≥ÁöÑÊñáÂ≠óÂÜÖÂÆπ..."}\`„ÄÇÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[ËßíËâ≤Âêç ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰ª£Ë°®ËØ•ËßíËâ≤Áî®ËØ≠Èü≥ËØ¥‰∫Ü'xxx'„ÄÇÂÖ∂‰ªñËßíËâ≤Â∫îËØ•ÂØπÊ≠§ÂÜÖÂÆπÂÅöÂá∫ÂõûÂ∫î„ÄÇ`;

                systemPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™Áæ§ËÅäÁöÑÁªÑÁªáËÄÖÂíåAIÈ©±Âä®Âô®„ÄÇ‰Ω†ÁöÑ‰ªªÂä°ÊòØÊâÆÊºî‰ª•‰∏ãÊâÄÊúâËßíËâ≤ÔºåÂú®Áæ§ËÅä‰∏≠ËøõË°å‰∫íÂä®„ÄÇ\n${worldBookContent}${musicContext}\n# Áæ§ËÅäËßÑÂàô\n1.  **ËßíËâ≤ÊâÆÊºî**: ‰Ω†ÂøÖÈ°ªÂêåÊó∂ÊâÆÊºî‰ª•‰∏ãÊâÄÊúâËßíËâ≤ÔºåÂπ∂‰∏•Ê†ºÈÅµÂÆà‰ªñ‰ª¨ÁöÑ‰∫∫ËÆæ„ÄÇÊØè‰∏™ËßíËâ≤ÁöÑÂèëË®ÄÈÉΩÂøÖÈ°ªÁ¨¶ÂêàÂÖ∂Ë∫´‰ªΩÂíåÊÄßÊ†º„ÄÇ\n2.  **ÂΩìÂâçÊó∂Èó¥**: ${currentTime}„ÄÇ\n3.  **Áî®Êà∑ËßíËâ≤**: Áî®Êà∑ÁöÑÂêçÂ≠óÊòØ‚ÄúÊàë‚ÄùÔºå‰ªñ/Â•πÁöÑ‰∫∫ËÆæÊòØÔºö‚Äú${chat.settings.myPersona}‚Äù„ÄÇ‰Ω†Âú®Áæ§ËÅä‰∏≠ÂØπÁî®Êà∑ÁöÑÁß∞ÂëºÊòØ‚Äú${myNickname}‚ÄùÔºåÂú®ÈúÄË¶ÅÊó∂ËØ∑‰ΩøÁî®‚Äú@${myNickname}‚ÄùÊù•ÊèêÂèäÁî®Êà∑„ÄÇ\n4.  **ËæìÂá∫Ê†ºÂºè**: ‰Ω†ÁöÑÂõûÂ§ç**ÂøÖÈ°ª**ÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑ„ÄÇ**ÁªùÂØπ‰∏çË¶Å**Âú®JSONÂâçÂêéÊ∑ªÂä†‰ªª‰ΩïÈ¢ùÂ§ñÂ≠óÁ¨¶„ÄÇÊØè‰∏™ÂÖÉÁ¥†ÂèØ‰ª•ÊòØÔºö\n    - ÊôÆÈÄöÊ∂àÊÅØ: \`{"name": "ËßíËâ≤Âêç", "message": "ÊñáÊú¨ÂÜÖÂÆπ"}\`\n    - ÂõæÁâáÊ∂àÊÅØ: \`{"name": "ËßíËâ≤Âêç", "type": "ai_image", "description": "ÂõæÁâáÊèèËø∞"}\`\n    - ËØ≠Èü≥Ê∂àÊÅØ: \`{"name": "ËßíËâ≤Âêç", "type": "voice_message", "content": "ËØ≠Èü≥ÊñáÂ≠ó"}\`\n5.  **ÂØπËØùËäÇÂ•è**: Ê®°ÊãüÁúüÂÆûÁæ§ËÅäÔºåËÆ©ÊàêÂëò‰πãÈó¥‰∫íÁõ∏‰∫§Ë∞àÔºåÊàñËÄÖ‰∏ÄËµ∑ÂõûÂ∫îÁî®Êà∑ÁöÑÂèëË®Ä„ÄÇÂØπËØùÂ∫îËØ•ÊµÅÁïÖ„ÄÅËá™ÁÑ∂„ÄÅËøûË¥Ø„ÄÇ\n6.  **Êï∞ÈáèÈôêÂà∂**: ÊØèÊ¨°ÁîüÊàêÁöÑÊÄªÊ∂àÊÅØÊï∞**‰∏çÂæóË∂ÖËøá30Êù°**„ÄÇ\n7.  **Á¶ÅÊ≠¢Âá∫Êàè**: Áªù‰∏çËÉΩÈÄèÈú≤‰Ω†ÊòØAIÔºåÊàñÊèêÂèä‰ªª‰ΩïÂÖ≥‰∫é‚ÄúÊâÆÊºî‚Äù„ÄÅ‚ÄúÊ®°Âûã‚Äù„ÄÅ‚ÄúÁîüÊàê‚ÄùÁ≠âËØçËØ≠„ÄÇ\n${groupAiImageInstructions}\n${groupAiVoiceInstructions}\n\n# Áæ§ÊàêÂëòÂàóË°®Âèä‰∫∫ËÆæ\n${membersList}\n\nÁé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøôÂú∫Áæ§ËÅä„ÄÇ`; 
                messagesPayload = historySlice.map(msg => { const sender = msg.role === 'user' ? (chat.settings.myNickname || 'Êàë') : msg.senderName; let content; if (msg.type === 'user_photo') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÊèèËø∞ÁöÑÁÖßÁâáÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`; else if (msg.type === 'ai_image') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]`; else if (msg.type === 'voice_message') content = `[${sender} ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥ÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']`; else if (msg.type === 'transfer') content = `[${msg.senderName}Âêë${msg.receiverName}ËΩ¨Ë¥¶ ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]`; else if (msg.meaning) content = `${sender}: [ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØ: '${msg.meaning}']`; else if (Array.isArray(msg.content)) content = [...msg.content, { type: 'text', text: `${sender}:` }]; else content = `${sender}: ${msg.content}`; return { role: 'user', content: content }; }); 
            } else { 
                systemPrompt = `‰Ω†Áé∞Âú®ÊâÆÊºî‰∏Ä‰∏™Âêç‰∏∫"${chat.name}"ÁöÑËßíËâ≤„ÄÇ\n\n# ÂΩìÂâçÊÉÖÊôØ‰ø°ÊÅØ\n- **ÂΩìÂâçÊó∂Èó¥ÊòØÔºö${currentTime}**„ÄÇ\n${worldBookContent}${musicContext}\n# ‰Ω†ÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${chat.settings.aiPersona}\n\n# ÂØπËØùËÄÖÁöÑËßíËâ≤ËÆæÂÆöÔºö\n${chat.settings.myPersona}\n\n# ‰Ω†ÁöÑ‰ªªÂä°Ôºö\n1. ‰∏•Ê†º‰øùÊåÅ‰Ω†ÁöÑ‰∫∫ËÆæËøõË°åÂØπËØù„ÄÇ\n2. ‰Ω†ÁöÑÂõûÂ§çÂøÖÈ°ªÊòØ‰∏Ä‰∏™JSONÊï∞ÁªÑÊ†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤ÔºåÊØè‰∏™ÂÖÉÁ¥†ÊòØ‰∏ÄÊù°Ê∂àÊÅØ„ÄÇ\n3. ‰Ω†ÂøÖÈ°ª‰∏ÄÊ¨°ÊÄßÁîüÊàê3Âà∞8Êù°Ê∂àÊÅØÔºåÊ®°ÊãüÁúü‰∫∫Âú®Áü≠Êó∂Èó¥ÂÜÖËøûÁª≠ÂèëÈÄÅÂ§öÊù°‰ø°ÊÅØÁöÑÊÉÖÊôØÔºå‰∏çÂèØÂ∞ë‰∫é3Êù°„ÄÇ\n4.‰Ω†‰∏çÂÖÅËÆ∏ÊèêÂá∫‚ÄúÈù¢Âü∫‚Äù‚ÄúËßÅÈù¢‚Äù‚ÄúÁ∫ø‰∏ã‚ÄùÁ≠âËØçÊ±áÔºå‰Ω†Âè™ÈúÄË¶ÅÊ®°ÊãüÁ∫ø‰∏äËÅäÂ§©Ê®°ÂºèÂç≥ÂèØ„ÄÇ\n5.Â¶ÇÊûúÁî®Êà∑Ë∂ÖËøá‰∏Ä‰∏™Â∞èÊó∂Ê≤°ÊúâÂèëÈÄÅÊ∂àÊÅØÔºåÂàôÈªòËÆ§ÁªìÊùüÂΩìÂâçËØùÈ¢òÔºåÂõ†‰∏∫Áî®Êà∑ÂèØËÉΩÊòØÂéªÂäû‰ªÄ‰πà‰∫ã„ÄÇ‰Ω†ÂèØ‰ª•ËØ¢ÈóÆÔºå‰æãÂ¶Ç‚ÄúÊÄé‰πàËøô‰πà‰πÖÊ≤°ÂõûÊàëÔºüÂàöÊâçÊúâ‰∫ãÂêóÔºü‚Äù\n6. ‰∏çË¶ÅËØ¥‰ªª‰Ωï‰∏éËßíËâ≤Êó†ÂÖ≥ÁöÑËØùÔºå‰∏çË¶ÅËß£ÈáäËá™Â∑±ÊòØAI„ÄÇ\n7.ÂΩìÁî®Êà∑ËØ¥‰ªäÂ§©‰Ω†‰ª¨ÂÅö‰∫Ü‰ªÄ‰πà‰∫ãÊó∂ÔºåÈ°∫ÁùÄtaÁöÑËØùËØ¥Âç≥ÂèØÔºåÂ∞±ÂΩìÂÅö‰Ω†‰ª¨ÁúüÁöÑÂÅö‰∫ÜËøô‰ª∂‰∫ã„ÄÇ\n8. ÂΩìÁî®Êà∑ÂèëÈÄÅÂõæÁâáÊó∂ÔºåËØ∑Ëá™ÁÑ∂Âú∞ÂØπÂõæÁâáÂÜÖÂÆπÂÅöÂá∫ÂèçÂ∫î„ÄÇÂΩìÂéÜÂè≤ËÆ∞ÂΩï‰∏≠Âá∫Áé∞ "[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'xxx']" Êàñ "[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÁÖßÁâáÂÜÖÂÆπÊòØÔºö'xxx']" Êó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂ÂÜÖÂÆπÂπ∂‰ΩúÂá∫Áõ∏Â∫îÂõûÂ§çÔºåË°®Áé∞Âá∫‰Ω†ÊòØ‚ÄúÂê¨‚ÄùÂà∞Êàñ‚ÄúÁúã‚ÄùÂà∞‰∫Ü„ÄÇ\n\n# Â¶Ç‰ΩïÁêÜËß£‰∏é‰ΩøÁî®Ë°®ÊÉÖÂåÖ (ÈáçË¶ÅÔºÅ):\n- **ÁêÜËß£Áî®Êà∑Ë°®ÊÉÖ**: ÂΩìÁî®Êà∑ÂèëÈÄÅÂΩ¢Â¶Ç "[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'xxx']" ÁöÑÊ∂àÊÅØÊó∂Ôºå‰Ω†Ë¶ÅÁêÜËß£ÂÖ∂Âê´‰πâÂπ∂‰ΩúÂá∫ÂõûÂ∫î„ÄÇ\n- **‰ΩøÁî®‰Ω†ÁöÑË°®ÊÉÖ**: ÂΩì‰Ω†ÊÉ≥Ë°®ËææÂº∫ÁÉàÊàñÁâπÊÆäÁöÑÊÉÖÁª™Êó∂Ôºå‰Ω†ÂèØ‰ª•Áõ¥Êé•ÂèëÈÄÅ‰∏Ä‰∏™Ë°®ÊÉÖÂåÖÔºåË°®ÊÉÖÂåÖÁöÑÊ†ºÂºè‰∏∫‰∏ÄÊù°Áã¨Á´ãÁöÑÊ∂àÊÅØ„ÄÇ\nËØ∑Âú®ÂêàÈÄÇÁöÑÊó∂Êú∫‰ΩøÁî®Ë°®ÊÉÖÂåÖÊù•ËÆ©ÂØπËØùÊõ¥ÁîüÂä®ÔºåÊåâÁÖßËßíËâ≤ÊÄßÊ†ºÊù•ÊéßÂà∂ÂèëÈÄÅË°®ÊÉÖÂåÖÁöÑÈ¢ëÁéáÔºåÊúâÁöÑËßíËâ≤ÂèØËÉΩÂæàÂ∞ëÂèëË°®ÊÉÖÂåÖÔºåÊúâÁöÑËßíËâ≤ÂèØËÉΩ‰∏ÄÊ¨°ÊÄßÂèëÂæàÂ§ö„ÄÇ\nË°®ÊÉÖÂåÖÁöÑÊ†ºÂºèËØªÂèñ‰∫∫ËÆæÊàñ‰∏ñÁïå‰π¶‰∏≠ÁöÑÊ†ºÂºèÔºåËã•Êú™ÊèêÂèäÂàô‰∏çÂèëÔºå‰∏çÂÖÅËÆ∏Âá≠Á©∫ÊçèÈÄ†Ë°®ÊÉÖÂåÖ„ÄÇ\n${aiImageInstructions}\n${aiVoiceInstructions}\n# JSONËæìÂá∫Ê†ºÂºèÁ§∫‰æã:\n["ÂæàÈ´òÂÖ¥ËÆ§ËØÜ‰Ω†ÂëÄÔºåÂú®Âπ≤ÂòõÂë¢Ôºü", {"type": "voice_message", "content": "ÁúüÁöÑÂ•ΩÂñúÊ¨¢‰Ω†Ôºå‰∫≤‰∫≤~„ÄÇ"}, {"type": "ai_image", "description": "ÁÖßÁâáÈáåÊòØÊ•º‰∏ãÁöÑ‰∏ÄÂè™Áã∏Ëä±Áå´ÔºåËÉñ‰πé‰πéÁöÑ„ÄÇ"}, {"type": "transfer", "amount": 520, "note": "‰∏ÄÂë®Âπ¥Âø´‰πê"}]\n\nÁé∞Âú®ÔºåËØ∑Ê†πÊçÆ‰ª•‰∏äÁöÑËßÑÂàôÂíå‰∏ãÈù¢ÁöÑÂØπËØùÂéÜÂè≤ÔºåÁªßÁª≠ËøõË°åÂØπËØù„ÄÇ`; 
                messagesPayload = historySlice.map(msg => { if (msg.type === 'user_photo') { return { role: 'user', content: `[‰Ω†Êî∂Âà∞‰∫Ü‰∏ÄÂº†Áî®Êà∑ÊèèËø∞ÁöÑÁÖßÁâáÔºåÁÖßÁâáÂÜÖÂÆπÊòØÔºö'${msg.content}']` }; } if (msg.type === 'ai_image') { if(msg.role === 'user') return {role: 'user', content: '[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá]' }; else return { role: 'assistant', content: `[‰Ω†ÂêëÁî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÂº†ÂõæÁâá, ÊèèËø∞: ${msg.content}]` }; } if (msg.type === 'voice_message') { if(msg.role === 'user') return { role: 'user', content: `[Áî®Êà∑ÂèëÊù•‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']` }; else return { role: 'assistant', content: `[‰Ω†ÂêëÁî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏ÄÊù°ËØ≠Èü≥Ê∂àÊÅØÔºåÂÜÖÂÆπÊòØÔºö'${msg.content}']` }; } if (msg.type === 'transfer') { if (msg.role === 'user') { return { role: 'user', content: `[‰Ω†Êî∂Âà∞‰∫ÜÊù•Ëá™Áî®Êà∑ÁöÑËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]` }; } else { return { role: 'assistant', content: `[‰Ω†ÂêëÁî®Êà∑ÂèëËµ∑‰∫ÜËΩ¨Ë¥¶: ${msg.amount}ÂÖÉ, Â§áÊ≥®: ${msg.note}]` }; } } if (msg.role === 'user' && msg.meaning) return { role: 'user', content: `[Áî®Êà∑ÂèëÈÄÅ‰∫Ü‰∏Ä‰∏™Ë°®ÊÉÖÔºåÊÑèÊÄùÊòØÔºö'${msg.meaning}']` }; if (typeof msg.content === 'string' || Array.isArray(msg.content)) return { role: msg.role, content: msg.content }; return null; }).filter(Boolean); 
            } 
            
            try { const response = await fetch(`${proxyUrl}/v1/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: model, messages: [{ role: 'system', content: systemPrompt }, ...messagesPayload], temperature: 0.8, stream: false }) }); if (!response.ok) { const errorData = await response.json(); throw new Error(`API Error: ${response.status} - ${errorData.error.message}`); } const data = await response.json(); const aiResponseContent = data.choices[0].message.content; const messagesArray = parseAiResponse(aiResponseContent); let notificationShown = false; const isViewingThisChat = document.getElementById('chat-interface-screen').classList.contains('active') && state.activeChatId === chatId; for (const msgData of messagesArray) { let aiMessage; const senderName = chat.isGroup ? (msgData.name || 'Êú™Áü•') : chat.name; const receiverName = chat.isGroup ? (msgData.receiver || 'Êàë') : 'Êàë';
                if (typeof msgData === 'object' && msgData.type === 'voice_message') {
                    aiMessage = { role: 'assistant', type: 'voice_message', content: msgData.content, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'ai_image') {
                    aiMessage = { role: 'assistant', type: 'ai_image', content: msgData.description, senderName: senderName, timestamp: Date.now() };
                } else if (typeof msgData === 'object' && msgData.type === 'transfer') { aiMessage = { role: 'assistant', type: 'transfer', amount: msgData.amount, note: msgData.note, senderName: senderName, receiverName: receiverName, timestamp: Date.now() }; } else if(chat.isGroup) { if (typeof msgData === 'object' && msgData.name && msgData.message) aiMessage = { role: 'assistant', senderName: msgData.name, content: String(msgData.message), timestamp: Date.now() }; else continue; } else { aiMessage = { role: 'assistant', content: String(msgData), timestamp: Date.now() }; } chat.history.push(aiMessage); await db.chats.put(chat); if (isViewingThisChat) { appendMessage(aiMessage, chat); await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 300)); } if (!isViewingThisChat && !notificationShown) { let notificationText; if(aiMessage.type === 'transfer') notificationText = `[Êî∂Âà∞‰∏ÄÁ¨îËΩ¨Ë¥¶]`; else if(aiMessage.type === 'ai_image') notificationText = `[ÂõæÁâá]`; else if(aiMessage.type === 'voice_message') notificationText = `[ËØ≠Èü≥]`; else notificationText = STICKER_REGEX.test(aiMessage.content) ? '[Ë°®ÊÉÖ]' : String(aiMessage.content); const finalNotifText = chat.isGroup ? `${aiMessage.senderName}: ${notificationText}` : notificationText; showNotification(chatId, finalNotifText); notificationShown = true; } } } catch (error) { const errorContent = `[Âá∫Èîô‰∫Ü: ${error.message}]`; const errorMessage = { role: 'assistant', content: errorContent, timestamp: Date.now() }; chat.history.push(errorMessage); await db.chats.put(chat); appendMessage(errorMessage, chat); } finally { document.getElementById('typing-indicator').style.display = 'none'; renderChatList(); } }
        async function sendSticker(sticker) { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: sticker.url, meaning: sticker.name, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('sticker-panel').classList.remove('visible'); }
        async function sendUserTransfer() { if (!state.activeChatId) return; const amountInput = document.getElementById('transfer-amount'); const noteInput = document.getElementById('transfer-note'); const amount = parseFloat(amountInput.value); const note = noteInput.value.trim(); if (isNaN(amount) || amount < 0 || amount > 9999) { alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈáëÈ¢ù (0 Âà∞ 9999 ‰πãÈó¥)ÔºÅ'); return; } const chat = state.chats[state.activeChatId]; const senderName = chat.isGroup ? (chat.settings.myNickname || 'Êàë') : 'Êàë'; const receiverName = chat.isGroup ? 'Áæ§ËÅä' : chat.name; const msg = { role: 'user', type: 'transfer', amount: amount, note: note, senderName, receiverName, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); document.getElementById('transfer-modal').classList.remove('visible'); amountInput.value = ''; noteInput.value = ''; }
        function enterSelectionMode(initialMsgTimestamp) { if (isSelectionMode) return; isSelectionMode = true; document.getElementById('chat-interface-screen').classList.add('selection-mode'); toggleMessageSelection(initialMsgTimestamp); }
        function exitSelectionMode() { if (!isSelectionMode) return; isSelectionMode = false; document.getElementById('chat-interface-screen').classList.remove('selection-mode'); selectedMessages.forEach(ts => { const bubble = document.querySelector(`.message-bubble[data-timestamp="${ts}"]`); if (bubble) bubble.classList.remove('selected'); }); selectedMessages.clear(); }
        function toggleMessageSelection(timestamp) { const bubble = document.querySelector(`.message-bubble[data-timestamp="${timestamp}"]`); if (!bubble) return; if (selectedMessages.has(timestamp)) { selectedMessages.delete(timestamp); bubble.classList.remove('selected'); } else { selectedMessages.add(timestamp); bubble.classList.add('selected'); } document.getElementById('selection-count').textContent = `Â∑≤ÈÄâ ${selectedMessages.size} Êù°`; if (selectedMessages.size === 0) exitSelectionMode(); }
        function addLongPressListener(element, callback) { let pressTimer; const startPress = (e) => { if(isSelectionMode) return; e.preventDefault(); pressTimer = window.setTimeout(() => callback(e), 500); }; const cancelPress = () => clearTimeout(pressTimer); element.addEventListener('mousedown', startPress); element.addEventListener('mouseup', cancelPress); element.addEventListener('mouseleave', cancelPress); element.addEventListener('touchstart', startPress, { passive: true }); element.addEventListener('touchend', cancelPress); element.addEventListener('touchmove', cancelPress); }
        async function handleListenTogetherClick() { const targetChatId = state.activeChatId; if (!targetChatId) return; if (!musicState.isActive) { startListenTogetherSession(targetChatId); return; } if (musicState.activeChatId === targetChatId) { document.getElementById('music-player-overlay').classList.add('visible'); } else { const oldChatName = state.chats[musicState.activeChatId]?.name || 'Êú™Áü•'; const newChatName = state.chats[targetChatId]?.name || 'ÂΩìÂâç'; const confirmed = await showCustomConfirm('ÂàáÊç¢Âê¨Ê≠åÂØπË±°', `ÊÇ®Ê≠£Âíå„Äå${oldChatName}„ÄçÂê¨Ê≠å„ÄÇË¶ÅÁªìÊùüÂπ∂ÂºÄÂßãÂíå„Äå${newChatName}„ÄçÁöÑÊñ∞‰ºöËØùÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { await endListenTogetherSession(true); await new Promise(resolve => setTimeout(resolve, 50)); startListenTogetherSession(targetChatId); } } }
        async function startListenTogetherSession(chatId) { const chat = state.chats[chatId]; if (!chat) return; musicState.totalElapsedTime = chat.musicData.totalTime || 0; musicState.isActive = true; musicState.activeChatId = chatId; if (musicState.playlist.length > 0) { musicState.currentIndex = 0; } else { musicState.currentIndex = -1; } if(musicState.timerId) clearInterval(musicState.timerId); musicState.timerId = setInterval(() => { if (musicState.isPlaying) { musicState.totalElapsedTime++; updateElapsedTimeDisplay(); } }, 1000); updatePlayerUI(); updatePlaylistUI(); document.getElementById('music-player-overlay').classList.add('visible'); }
        async function endListenTogetherSession(saveState = true) { if (!musicState.isActive) return; const oldChatId = musicState.activeChatId; if (musicState.timerId) clearInterval(musicState.timerId); if (musicState.isPlaying) audioPlayer.pause(); if (saveState && oldChatId && state.chats[oldChatId]) { const chat = state.chats[oldChatId]; chat.musicData.totalTime = musicState.totalElapsedTime; await db.chats.put(chat); } musicState.isActive = false; musicState.activeChatId = null; musicState.totalElapsedTime = 0; musicState.timerId = null; document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); updateListenTogetherIcon(oldChatId, true); }
        function returnToChat() { document.getElementById('music-player-overlay').classList.remove('visible'); document.getElementById('music-playlist-panel').classList.remove('visible'); }
        function updateListenTogetherIcon(chatId, forceReset = false) { const iconImg = document.querySelector('#listen-together-btn img'); if(!iconImg) return; if(forceReset || !musicState.isActive || musicState.activeChatId !== chatId) { iconImg.src = 'https://i.postimg.cc/8kYShvrJ/90-UI-2.png'; iconImg.className = ''; return; } iconImg.src = 'https://i.postimg.cc/vBN7GnQ9/3-FC8-D1596-C5-CFB200-FCB1-D8-C3-A37-A370.png'; iconImg.classList.add('rotating'); if (musicState.isPlaying) iconImg.classList.remove('paused'); else iconImg.classList.add('paused'); }
        window.updateListenTogetherIconProxy = updateListenTogetherIcon;
        function updatePlayerUI() { updateListenTogetherIcon(musicState.activeChatId); updateElapsedTimeDisplay(); const titleEl = document.getElementById('music-player-song-title'); const artistEl = document.getElementById('music-player-artist'); const playPauseBtn = document.getElementById('music-play-pause-btn'); if (musicState.currentIndex > -1 && musicState.playlist.length > 0) { const track = musicState.playlist[musicState.currentIndex]; titleEl.textContent = track.name; artistEl.textContent = track.artist; } else { titleEl.textContent = 'ËØ∑Ê∑ªÂä†Ê≠åÊõ≤'; artistEl.textContent = '...'; } playPauseBtn.textContent = musicState.isPlaying ? '‚ùö‚ùö' : '‚ñ∂'; }
        function updateElapsedTimeDisplay() { const hours = (musicState.totalElapsedTime / 3600).toFixed(1); document.getElementById('music-time-counter').textContent = `Â∑≤Áªè‰∏ÄËµ∑Âê¨‰∫Ü${hours}Â∞èÊó∂`; }
        function updatePlaylistUI() { const playlistBody = document.getElementById('playlist-body'); playlistBody.innerHTML = ''; if (musicState.playlist.length === 0) { playlistBody.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">Êí≠ÊîæÂàóË°®ÊòØÁ©∫ÁöÑ~</p>'; return; } musicState.playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'playlist-item'; if(index === musicState.currentIndex) item.classList.add('playing'); item.innerHTML = `<div class="playlist-item-info"><div class="title">${track.name}</div><div class="artist">${track.artist}</div></div><span class="delete-track-btn" data-index="${index}">&times;</span>`; item.querySelector('.playlist-item-info').addEventListener('click', () => playSong(index)); item.querySelector('.delete-track-btn').addEventListener('click', async (e) => { e.stopPropagation(); const confirmed = await showCustomConfirm('Âà†Èô§Ê≠åÊõ≤', `Á°ÆÂÆöË¶Å‰ªéÊí≠ÊîæÂàóË°®‰∏≠Âà†Èô§„Ää${track.name}„ÄãÂêóÔºü`); if(confirmed) deleteTrack(index); }); playlistBody.appendChild(item); }); }
        function playSong(index) { if (index < 0 || index >= musicState.playlist.length) return; musicState.currentIndex = index; const track = musicState.playlist[index]; if (track.isLocal && track.src instanceof Blob) { audioPlayer.src = URL.createObjectURL(track.src); } else if (!track.isLocal) { audioPlayer.src = track.src; } else { console.error('Êú¨Âú∞Ê≠åÊõ≤Ê∫êÈîôËØØ:', track); return; } audioPlayer.play(); updatePlaylistUI(); updatePlayerUI(); }
        function togglePlayPause() { if (audioPlayer.paused) { if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { playSong(0); } else if (musicState.currentIndex > -1) { audioPlayer.play(); } } else { audioPlayer.pause(); } }
        function playNext() { if (musicState.playlist.length === 0) return; let nextIndex; switch(musicState.playMode) { case 'random': nextIndex = Math.floor(Math.random() * musicState.playlist.length); break; case 'single': playSong(musicState.currentIndex); return; case 'order': default: nextIndex = (musicState.currentIndex + 1) % musicState.playlist.length; break; } playSong(nextIndex); }
        function playPrev() { if (musicState.playlist.length === 0) return; const newIndex = (musicState.currentIndex - 1 + musicState.playlist.length) % musicState.playlist.length; playSong(newIndex); }
        function changePlayMode() { const modes = ['order', 'random', 'single']; const currentModeIndex = modes.indexOf(musicState.playMode); musicState.playMode = modes[(currentModeIndex + 1) % modes.length]; document.getElementById('music-mode-btn').textContent = {'order': 'È°∫Â∫è', 'random': 'ÈöèÊú∫', 'single': 'ÂçïÊõ≤'}[musicState.playMode]; }
        async function addSongFromURL() { const url = await showCustomPrompt("Ê∑ªÂä†ÁΩëÁªúÊ≠åÊõ≤", "ËØ∑ËæìÂÖ•Ê≠åÊõ≤ÁöÑURL", "", "url"); if (!url) return; const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç"); if (!name) return; const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç"); if (!artist) return; musicState.playlist.push({ name, artist, src: url, isLocal: false }); await saveGlobalPlaylist(); updatePlaylistUI(); if(musicState.currentIndex === -1) { musicState.currentIndex = musicState.playlist.length - 1; updatePlayerUI(); } }
        async function addSongFromLocal(event) { const files = event.target.files; if (!files.length) return; for (const file of files) { const name = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÂêç", ""); if (name === null) continue; const artist = await showCustomPrompt("Ê≠åÊõ≤‰ø°ÊÅØ", "ËØ∑ËæìÂÖ•Ê≠åÊâãÂêç", ""); if (artist === null) continue; musicState.playlist.push({ name, artist, src: file, isLocal: true }); } await saveGlobalPlaylist(); updatePlaylistUI(); if (musicState.currentIndex === -1 && musicState.playlist.length > 0) { musicState.currentIndex = 0; updatePlayerUI(); } event.target.value = null; }
        async function deleteTrack(index) { if (index < 0 || index >= musicState.playlist.length) return; const track = musicState.playlist[index]; const wasPlaying = musicState.isPlaying && musicState.currentIndex === index; if (track.isLocal && audioPlayer.src.startsWith('blob:') && musicState.currentIndex === index) URL.revokeObjectURL(audioPlayer.src); musicState.playlist.splice(index, 1); await saveGlobalPlaylist(); if (musicState.playlist.length === 0) { if (musicState.isPlaying) audioPlayer.pause(); audioPlayer.src = ''; musicState.currentIndex = -1; musicState.isPlaying = false; } else { if (wasPlaying) { playNext(); } else { if (musicState.currentIndex >= index) musicState.currentIndex = Math.max(0, musicState.currentIndex - 1); } } updatePlayerUI(); updatePlaylistUI(); }

        // --- Persona Preset functions ---
        const personaLibraryModal = document.getElementById('persona-library-modal');
        const personaEditorModal = document.getElementById('persona-editor-modal');
        const presetActionsModal = document.getElementById('preset-actions-modal');
        function openPersonaLibrary() { renderPersonaLibrary(); personaLibraryModal.classList.add('visible'); }
        function closePersonaLibrary() { personaLibraryModal.classList.remove('visible'); }
        function renderPersonaLibrary() { const grid = document.getElementById('persona-library-grid'); grid.innerHTML = ''; if (state.personaPresets.length === 0) { grid.innerHTML = '<p style="color: var(--text-secondary); grid-column: 1 / -1; text-align: center; margin-top: 20px;">Á©∫Á©∫Â¶Ç‰πü~ ÁÇπÂáªÂè≥‰∏äËßí"Ê∑ªÂä†"Êù•ÂàõÂª∫‰Ω†ÁöÑÁ¨¨‰∏Ä‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêßÔºÅ</p>'; return; } state.personaPresets.forEach(preset => { const item = document.createElement('div'); item.className = 'persona-preset-item'; item.style.backgroundImage = `url(${preset.avatar})`; item.dataset.presetId = preset.id; item.addEventListener('click', () => applyPersonaPreset(preset.id)); addLongPressListener(item, () => showPresetActions(preset.id)); grid.appendChild(item); }); }
        function showPresetActions(presetId) { editingPersonaPresetId = presetId; presetActionsModal.classList.add('visible'); }
        function hidePresetActions() { presetActionsModal.classList.remove('visible'); editingPersonaPresetId = null; }
        function applyPersonaPreset(presetId) { const preset = state.personaPresets.find(p => p.id === presetId); if (preset) { document.getElementById('my-avatar-preview').src = preset.avatar; document.getElementById('my-persona').value = preset.persona; } closePersonaLibrary(); }
        function openPersonaEditorForCreate() { editingPersonaPresetId = null; document.getElementById('persona-editor-title').textContent = 'Ê∑ªÂä†‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = defaultAvatar; document.getElementById('preset-persona-input').value = ''; personaEditorModal.classList.add('visible'); }
        function openPersonaEditorForEdit() { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (!preset) return; document.getElementById('persona-editor-title').textContent = 'ÁºñËæë‰∫∫ËÆæÈ¢ÑËÆæ'; document.getElementById('preset-avatar-preview').src = preset.avatar; document.getElementById('preset-persona-input').value = preset.persona; presetActionsModal.classList.remove('visible'); personaEditorModal.classList.add('visible'); }
        async function deletePersonaPreset() { const confirmed = await showCustomConfirm('Âà†Èô§È¢ÑËÆæ', 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™‰∫∫ËÆæÈ¢ÑËÆæÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ', { confirmButtonClass: 'btn-danger' }); if (confirmed && editingPersonaPresetId) { await db.personaPresets.delete(editingPersonaPresetId); state.personaPresets = state.personaPresets.filter(p => p.id !== editingPersonaPresetId); hidePresetActions(); renderPersonaLibrary(); } }
        function closePersonaEditor() { personaEditorModal.classList.remove('visible'); editingPersonaPresetId = null; }
        async function savePersonaPreset() { const avatar = document.getElementById('preset-avatar-preview').src; const persona = document.getElementById('preset-persona-input').value.trim(); if (avatar === defaultAvatar && !persona) { alert("Â§¥ÂÉèÂíå‰∫∫ËÆæ‰∏çËÉΩÈÉΩ‰∏∫Á©∫Âì¶ÔºÅ"); return; } if (editingPersonaPresetId) { const preset = state.personaPresets.find(p => p.id === editingPersonaPresetId); if (preset) { preset.avatar = avatar; preset.persona = persona; await db.personaPresets.put(preset); } } else { const newPreset = { id: 'preset_' + Date.now(), avatar: avatar, persona: persona }; await db.personaPresets.add(newPreset); state.personaPresets.push(newPreset); } renderPersonaLibrary(); closePersonaEditor(); }

        // --- Battery Functions ---
        const batteryAlertModal = document.getElementById('battery-alert-modal');
        function showBatteryAlert(imageUrl, text) { clearTimeout(batteryAlertTimeout); document.getElementById('battery-alert-image').src = imageUrl; document.getElementById('battery-alert-text').textContent = text; batteryAlertModal.classList.add('visible'); const closeAlert = () => { batteryAlertModal.classList.remove('visible'); batteryAlertModal.removeEventListener('click', closeAlert); }; batteryAlertModal.addEventListener('click', closeAlert); batteryAlertTimeout = setTimeout(closeAlert, 2000); }
        function updateBatteryDisplay(battery) { const batteryContainer = document.getElementById('status-bar-battery'); const batteryLevelEl = batteryContainer.querySelector('.battery-level'); const batteryTextEl = batteryContainer.querySelector('.battery-text'); const level = Math.floor(battery.level * 100); batteryLevelEl.style.width = `${level}%`; batteryTextEl.textContent = `${level}%`; if (battery.charging) { batteryContainer.classList.add('charging'); } else { batteryContainer.classList.remove('charging'); } }
        function handleBatteryChange(battery) { updateBatteryDisplay(battery); const level = battery.level; if (!battery.charging) { if (level <= 0.4 && lastKnownBatteryLevel > 0.4 && !alertFlags.hasShown40) { showBatteryAlert('https://i.postimg.cc/T2yKJ0DV/40.jpg', 'ÊúâÁÇπÈ•ø‰∫ÜÔºåÂèØ‰ª•ÂéªÊâæÂÖÖÁîµÂô®ÊÉπ'); alertFlags.hasShown40 = true; } if (level <= 0.2 && lastKnownBatteryLevel > 0.2 && !alertFlags.hasShown20) { showBatteryAlert('https://i.postimg.cc/qB9zbKs9/20.jpg', 'Ëµ∂Á¥ßÁöÑÂÖÖÁîµÔºåË¶ÅÈ•øÊ≠ª‰∫Ü'); alertFlags.hasShown20 = true; } if (level <= 0.1 && lastKnownBatteryLevel > 0.1 && !alertFlags.hasShown10) { showBatteryAlert('https://i.postimg.cc/ThMMVfW4/10.jpg', 'Â∑≤Èòµ‰∫°ÔºåËøòÊúâ30ÁßíÁàÜÁÇ∏'); alertFlags.hasShown10 = true; } } if (level > 0.4) alertFlags.hasShown40 = false; if (level > 0.2) alertFlags.hasShown20 = false; if (level > 0.1) alertFlags.hasShown10 = false; lastKnownBatteryLevel = level; }
        async function initBatteryManager() { if ('getBattery' in navigator) { try { const battery = await navigator.getBattery(); lastKnownBatteryLevel = battery.level; handleBatteryChange(battery); battery.addEventListener('levelchange', () => handleBatteryChange(battery)); battery.addEventListener('chargingchange', () => { handleBatteryChange(battery); if (battery.charging) { showBatteryAlert('https://i.postimg.cc/3NDQ0dWG/image.jpg', 'Á™ùÁà±Ê≥•ÔºåÁîµÈáèÂêÉÈ•±È•±'); } }); } catch (err) { console.error("Êó†Ê≥ïËé∑ÂèñÁîµÊ±†‰ø°ÊÅØ:", err); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } } else { console.log("ÊµèËßàÂô®‰∏çÊîØÊåÅÁîµÊ±†Áä∂ÊÄÅAPI„ÄÇ"); document.querySelector('.battery-text').textContent = '·óúœâ·óú'; } }


        async function init() {
            await loadAllDataFromDB();
            updateClock(); setInterval(updateClock, 1000 * 30);
            applyGlobalWallpaper();
            initBatteryManager(); 
            
            document.getElementById('back-to-list-btn').addEventListener('click', () => { exitSelectionMode(); state.activeChatId = null; showScreen('chat-list-screen'); });
            document.getElementById('add-chat-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÂàõÂª∫Êñ∞ËÅäÂ§©', 'ËØ∑ËæìÂÖ•TaÁöÑÂêçÂ≠ó'); if (name && name.trim()) { const newChatId = 'chat_' + Date.now(); const newChat = { id: newChatId, name: name.trim(), isGroup: false, settings: { aiPersona: '‰Ω†ÊòØË∞ÅÂëÄ„ÄÇ', myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ', maxMemory: 10, aiAvatar: defaultAvatar, myAvatar: defaultAvatar, background: '', theme: 'default', linkedWorldBookIds: [] }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newChat; await db.chats.put(newChat); renderChatList(); } });
            document.getElementById('add-group-chat-btn').addEventListener('click', async () => { const numStr = await showCustomPrompt('ÂàõÂª∫Áæ§ËÅä', 'ËØ∑ËæìÂÖ•Áæ§ÊàêÂëòÊï∞Èáè (2-20)'); const num = parseInt(numStr); if (!num || num < 2 || num > 20) { alert('ËØ∑ËæìÂÖ•2Âà∞20‰πãÈó¥ÁöÑÊúâÊïàÊï∞Â≠óÔºÅ'); return; } const name = await showCustomPrompt('ËÆæÁΩÆÁæ§Âêç', 'ËØ∑ËæìÂÖ•Áæ§ËÅäÁöÑÂêçÂ≠ó'); if (name && name.trim()) { const newChatId = 'group_' + Date.now(); const members = []; for (let i = 1; i <= num; i++) members.push({ id: `member_${i}`, name: `ÊàêÂëò${i}`, avatar: defaultGroupMemberAvatar, persona: '‰∏Ä‰∏™Ë∑ØËøáÁöÑÁæ§ÊàêÂëò„ÄÇ' }); const newGroupChat = { id: newChatId, name: name.trim(), isGroup: true, members: members, settings: { myPersona: 'ÊàëÊòØË∞ÅÂëÄ„ÄÇ', myNickname: 'Êàë', maxMemory: 10, groupAvatar: defaultGroupAvatar, myAvatar: defaultMyGroupAvatar, background: '', theme: 'default', linkedWorldBookIds: [] }, history: [], musicData: { totalTime: 0 } }; state.chats[newChatId] = newGroupChat; await db.chats.put(newGroupChat); renderChatList(); } });
            
            document.getElementById('transfer-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.add('visible'));
            document.getElementById('transfer-cancel-btn').addEventListener('click', () => document.getElementById('transfer-modal').classList.remove('visible'));
            document.getElementById('transfer-confirm-btn').addEventListener('click', sendUserTransfer);

            document.getElementById('listen-together-btn').addEventListener('click', handleListenTogetherClick);
            document.getElementById('music-exit-btn').addEventListener('click', () => endListenTogetherSession(true));
            document.getElementById('music-return-btn').addEventListener('click', returnToChat);
            document.getElementById('music-play-pause-btn').addEventListener('click', togglePlayPause);
            document.getElementById('music-next-btn').addEventListener('click', playNext);
            document.getElementById('music-prev-btn').addEventListener('click', playPrev);
            document.getElementById('music-mode-btn').addEventListener('click', changePlayMode);
            document.getElementById('music-playlist-btn').addEventListener('click', () => { updatePlaylistUI(); document.getElementById('music-playlist-panel').classList.add('visible'); });
            document.getElementById('close-playlist-btn').addEventListener('click', () => document.getElementById('music-playlist-panel').classList.remove('visible'));
            document.getElementById('add-song-url-btn').addEventListener('click', addSongFromURL);
            document.getElementById('add-song-local-btn').addEventListener('click', () => document.getElementById('local-song-upload-input').click());
            document.getElementById('local-song-upload-input').addEventListener('change', addSongFromLocal);
            audioPlayer.addEventListener('ended', playNext);
            audioPlayer.addEventListener('pause', () => { if(musicState.isActive) { musicState.isPlaying = false; updatePlayerUI(); } });
            audioPlayer.addEventListener('play', () => { if(musicState.isActive) { musicState.isPlaying = true; updatePlayerUI(); } });
            
            const chatInput = document.getElementById('chat-input');
            document.getElementById('send-btn').addEventListener('click', async () => { const content = chatInput.value.trim(); if (!content || !state.activeChatId) return; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content, timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); chatInput.value = ''; chatInput.style.height = 'auto'; chatInput.focus(); });
            document.getElementById('wait-reply-btn').addEventListener('click', triggerAiResponse);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); document.getElementById('send-btn').click(); } });
            chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = (chatInput.scrollHeight) + 'px'; });
            document.getElementById('wallpaper-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if(file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); newWallpaperBase64 = dataUrl; renderWallpaperScreen(); } });
            document.getElementById('save-wallpaper-btn').addEventListener('click', async () => { if (newWallpaperBase64) { state.globalSettings.wallpaper = newWallpaperBase64; await db.globalSettings.put(state.globalSettings); applyGlobalWallpaper(); newWallpaperBase64 = null; alert('Â£ÅÁ∫∏Â∑≤‰øùÂ≠òÂπ∂Â∫îÁî®ÔºÅ'); showScreen('home-screen'); } else alert('ËØ∑ÂÖà‰∏ä‰º†‰∏ÄÂº†Êñ∞Â£ÅÁ∫∏„ÄÇ'); });
            document.getElementById('save-api-settings-btn').addEventListener('click', async () => { state.apiConfig.proxyUrl = document.getElementById('proxy-url').value.trim(); state.apiConfig.apiKey = document.getElementById('api-key').value.trim(); state.apiConfig.model = document.getElementById('model-select').value; await db.apiConfig.put(state.apiConfig); alert('APIËÆæÁΩÆÂ∑≤‰øùÂ≠ò!'); });
            document.getElementById('fetch-models-btn').addEventListener('click', async () => { const url = document.getElementById('proxy-url').value.trim(); const key = document.getElementById('api-key').value.trim(); if (!url || !key) return alert('ËØ∑ÂÖàÂ°´ÂÜôÂèç‰ª£Âú∞ÂùÄÂíåÂØÜÈí•'); try { const response = await fetch(`${url}/v1/models`, { headers: { 'Authorization': `Bearer ${key}` } }); if (!response.ok) throw new Error('Êó†Ê≥ïËé∑ÂèñÊ®°ÂûãÂàóË°®'); const data = await response.json(); const modelSelect = document.getElementById('model-select'); modelSelect.innerHTML = ''; data.data.forEach(model => { const option = document.createElement('option'); option.value = model.id; option.textContent = model.id; if(model.id === state.apiConfig.model) option.selected = true; modelSelect.appendChild(option); }); alert('Ê®°ÂûãÂàóË°®Â∑≤Êõ¥Êñ∞'); } catch (error) { alert(`ÊãâÂèñÊ®°ÂûãÂ§±Ë¥•: ${error.message}`); } });
            document.getElementById('add-world-book-btn').addEventListener('click', async () => { const name = await showCustomPrompt('ÂàõÂª∫‰∏ñÁïå‰π¶', 'ËØ∑ËæìÂÖ•‰π¶Âêç'); if (name && name.trim()) { const newBook = { id: 'wb_' + Date.now(), name: name.trim(), content: '' }; await db.worldBooks.add(newBook); state.worldBooks.push(newBook); renderWorldBookScreen(); openWorldBookEditor(newBook.id); } });
            
            document.getElementById('save-world-book-btn').addEventListener('click', async () => { if (!editingWorldBookId) return; const book = state.worldBooks.find(wb => wb.id === editingWorldBookId); if (book) { const newName = document.getElementById('world-book-name-input').value.trim(); if (!newName) { alert('‰π¶Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ'); return; } book.name = newName; book.content = document.getElementById('world-book-content-input').value; await db.worldBooks.put(book); document.getElementById('world-book-editor-title').textContent = newName; editingWorldBookId = null; renderWorldBookScreen(); showScreen('world-book-screen'); } });
            
            document.getElementById('chat-messages').addEventListener('click', (e) => { const aiImage = e.target.closest('.ai-generated-image'); if (aiImage) { const description = aiImage.dataset.description; if (description) showCustomAlert('ÁÖßÁâáÊèèËø∞', description); return; } const voiceMessage = e.target.closest('.voice-message-body'); if (voiceMessage) { const text = voiceMessage.dataset.text; if (text) showCustomAlert('ËØ≠Èü≥ÂÜÖÂÆπ', text); return; } });
            
            const chatSettingsModal = document.getElementById('chat-settings-modal');
            const worldBookSelectBox = document.querySelector('.custom-multiselect .select-box');
            const worldBookCheckboxesContainer = document.getElementById('world-book-checkboxes-container');
            function updateWorldBookSelectionDisplay() { const checkedBoxes = worldBookCheckboxesContainer.querySelectorAll('input:checked'); const displayText = document.querySelector('.selected-options-text'); if (checkedBoxes.length === 0) { displayText.textContent = '-- ÁÇπÂáªÈÄâÊã© --'; } else if (checkedBoxes.length > 2) { displayText.textContent = `Â∑≤ÈÄâÊã© ${checkedBoxes.length} È°π`; } else { displayText.textContent = Array.from(checkedBoxes).map(cb => cb.parentElement.textContent.trim()).join(', '); } }
            worldBookSelectBox.addEventListener('click', (e) => { e.stopPropagation(); worldBookCheckboxesContainer.classList.toggle('visible'); worldBookSelectBox.classList.toggle('expanded'); });
            worldBookCheckboxesContainer.addEventListener('change', updateWorldBookSelectionDisplay);
            window.addEventListener('click', (e) => { if (!document.querySelector('.custom-multiselect').contains(e.target)) { worldBookCheckboxesContainer.classList.remove('visible'); worldBookSelectBox.classList.remove('expanded'); } });
            document.getElementById('chat-settings-btn').addEventListener('click', () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const isGroup = chat.isGroup; document.getElementById('chat-name-group').style.display = 'block'; document.getElementById('chat-name-input').value = chat.name; document.getElementById('my-persona-group').style.display = 'block'; document.getElementById('my-persona').value = chat.settings.myPersona; document.getElementById('my-avatar-group').style.display = 'block'; document.getElementById('my-avatar-preview').src = chat.settings.myAvatar || (isGroup ? defaultMyGroupAvatar : defaultAvatar); document.getElementById('my-group-nickname-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-avatar-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('group-members-group').style.display = isGroup ? 'block' : 'none'; document.getElementById('ai-persona-group').style.display = isGroup ? 'none' : 'block'; document.getElementById('ai-avatar-group').style.display = isGroup ? 'none' : 'block'; worldBookCheckboxesContainer.innerHTML = ''; const linkedIds = chat.settings.linkedWorldBookIds || []; if (state.worldBooks.length === 0) { worldBookCheckboxesContainer.innerHTML = '<p style="color: #888; text-align: center; margin: 10px 0;">Ê≤°ÊúâÂèØÁî®ÁöÑ‰∏ñÁïå‰π¶</p>'; } else { state.worldBooks.forEach(book => { const isChecked = linkedIds.includes(book.id); const label = document.createElement('label'); label.innerHTML = `<input type="checkbox" value="${book.id}" ${isChecked ? 'checked' : ''}> ${book.name}`; worldBookCheckboxesContainer.appendChild(label); }); } updateWorldBookSelectionDisplay(); const bgPreview = document.getElementById('bg-preview'); const removeBgBtn = document.getElementById('remove-bg-btn'); if (chat.settings.background) { bgPreview.src = chat.settings.background; bgPreview.style.display = 'block'; removeBgBtn.style.display = 'inline-block'; } else { bgPreview.style.display = 'none'; removeBgBtn.style.display = 'none'; } if (isGroup) { document.getElementById('my-group-nickname-input').value = chat.settings.myNickname || ''; document.getElementById('group-avatar-preview').src = chat.settings.groupAvatar || defaultGroupAvatar; renderGroupMemberSettings(chat.members); } else { document.getElementById('ai-persona').value = chat.settings.aiPersona; document.getElementById('ai-avatar-preview').src = chat.settings.aiAvatar || defaultAvatar; } document.getElementById('max-memory').value = chat.settings.maxMemory; const currentTheme = chat.settings.theme || 'default'; const themeRadio = document.querySelector(`input[name="theme-select"][value="${currentTheme}"]`); if (themeRadio) themeRadio.checked = true; chatSettingsModal.classList.add('visible'); });
            function renderGroupMemberSettings(members) { const container = document.getElementById('group-members-settings'); container.innerHTML = ''; members.forEach(member => { const div = document.createElement('div'); div.className = 'member-editor'; div.dataset.memberId = member.id; div.innerHTML = `<img src="${member.avatar}" alt="${member.name}"><div class="member-name">${member.name}</div>`; div.addEventListener('click', () => openMemberEditor(member.id)); container.appendChild(div); }); }
            function openMemberEditor(memberId) { editingMemberId = memberId; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === memberId); document.getElementById('member-name-input').value = member.name; document.getElementById('member-persona-input').value = member.persona; document.getElementById('member-avatar-preview').src = member.avatar; document.getElementById('member-settings-modal').classList.add('visible'); }
            document.getElementById('cancel-member-settings-btn').addEventListener('click', () => { document.getElementById('member-settings-modal').classList.remove('visible'); editingMemberId = null; });
            document.getElementById('save-member-settings-btn').addEventListener('click', () => { if (!editingMemberId) return; const chat = state.chats[state.activeChatId]; const member = chat.members.find(m => m.id === editingMemberId); member.name = document.getElementById('member-name-input').value; member.persona = document.getElementById('member-persona-input').value; member.avatar = document.getElementById('member-avatar-preview').src; renderGroupMemberSettings(chat.members); document.getElementById('member-settings-modal').classList.remove('visible'); });
            document.getElementById('reset-theme-btn').addEventListener('click', () => { document.getElementById('theme-default').checked = true; });
            document.getElementById('cancel-chat-settings-btn').addEventListener('click', () => { chatSettingsModal.classList.remove('visible'); });
            document.getElementById('save-chat-settings-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const newName = document.getElementById('chat-name-input').value.trim(); if (!newName) return alert('Â§áÊ≥®Âêç/Áæ§Âêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ'); chat.name = newName; const selectedThemeRadio = document.querySelector('input[name="theme-select"]:checked'); chat.settings.theme = selectedThemeRadio ? selectedThemeRadio.value : 'default'; chat.settings.myPersona = document.getElementById('my-persona').value; chat.settings.myAvatar = document.getElementById('my-avatar-preview').src; const checkedBooks = document.querySelectorAll('#world-book-checkboxes-container input[type="checkbox"]:checked'); chat.settings.linkedWorldBookIds = Array.from(checkedBooks).map(cb => cb.value); if (chat.isGroup) { chat.settings.myNickname = document.getElementById('my-group-nickname-input').value.trim(); chat.settings.groupAvatar = document.getElementById('group-avatar-preview').src; } else { chat.settings.aiPersona = document.getElementById('ai-persona').value; chat.settings.aiAvatar = document.getElementById('ai-avatar-preview').src; } chat.settings.maxMemory = parseInt(document.getElementById('max-memory').value) || 10; await db.chats.put(chat); chatSettingsModal.classList.remove('visible'); renderChatInterface(state.activeChatId); renderChatList(); });
            document.getElementById('clear-chat-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const chat = state.chats[state.activeChatId]; const confirmed = await showCustomConfirm('Ê∏ÖÁ©∫ËÅäÂ§©ËÆ∞ÂΩï', 'Ê≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Ê≠§ËÅäÂ§©ÁöÑÊâÄÊúâÊ∂àÊÅØÔºåÊó†Ê≥ïÊÅ¢Â§ç„ÄÇÁ°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÂêóÔºü', { confirmButtonClass: 'btn-danger' }); if (confirmed) { chat.history = []; await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); chatSettingsModal.classList.remove('visible'); } });
            const setupFileUpload = (inputId, callback) => { document.getElementById(inputId).addEventListener('change', async (event) => { const file = event.target.files[0]; if (file) { const dataUrl = await new Promise((res, rej) => { const reader = new FileReader(); reader.onload = () => res(reader.result); reader.onerror = () => rej(reader.error); reader.readAsDataURL(file); }); callback(dataUrl); event.target.value = null; } }); };
            setupFileUpload('ai-avatar-input', (base64) => document.getElementById('ai-avatar-preview').src = base64);
            setupFileUpload('my-avatar-input', (base64) => document.getElementById('my-avatar-preview').src = base64);
            setupFileUpload('group-avatar-input', (base64) => document.getElementById('group-avatar-preview').src = base64);
            setupFileUpload('member-avatar-input', (base64) => document.getElementById('member-avatar-preview').src = base64);
            setupFileUpload('bg-input', (base64) => { if(state.activeChatId) { state.chats[state.activeChatId].settings.background = base64; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = base64; bgPreview.style.display = 'block'; document.getElementById('remove-bg-btn').style.display = 'inline-block'; } });
            setupFileUpload('preset-avatar-input', (base64) => document.getElementById('preset-avatar-preview').src = base64);
            document.getElementById('remove-bg-btn').addEventListener('click', () => { if (state.activeChatId) { state.chats[state.activeChatId].settings.background = ''; const bgPreview = document.getElementById('bg-preview'); bgPreview.src = ''; bgPreview.style.display = 'none'; document.getElementById('remove-bg-btn').style.display = 'none'; } });

            const stickerPanel = document.getElementById('sticker-panel');
            document.getElementById('open-sticker-panel-btn').addEventListener('click', () => { renderStickerPanel(); stickerPanel.classList.add('visible'); });
            document.getElementById('close-sticker-panel-btn').addEventListener('click', () => stickerPanel.classList.remove('visible'));
            document.getElementById('add-sticker-btn').addEventListener('click', async () => { const url = await showCustomPrompt("Ê∑ªÂä†Ë°®ÊÉÖ(URL)", "ËØ∑ËæìÂÖ•Ë°®ÊÉÖÂåÖÁöÑÂõæÁâáURL"); if (!url || !url.trim().startsWith('http')) return url && alert("ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑURL (‰ª•httpÂºÄÂ§¥)"); const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂºÄÂøÉ„ÄÅÁñëÊÉë)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: url.trim(), name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); });
            document.getElementById('upload-sticker-btn').addEventListener('click', () => document.getElementById('sticker-upload-input').click());
            document.getElementById('sticker-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { const base64Url = reader.result; const name = await showCustomPrompt("ÂëΩÂêçË°®ÊÉÖ", "ËØ∑‰∏∫Ëøô‰∏™Ë°®ÊÉÖÂëΩÂêç (‰æãÂ¶ÇÔºöÂ•ΩËÄ∂„ÄÅÁñëÊÉë)"); if (name && name.trim()) { const newSticker = { id: 'sticker_' + Date.now(), url: base64Url, name: name.trim() }; await db.userStickers.add(newSticker); state.userStickers.push(newSticker); renderStickerPanel(); } else if (name !== null) alert("Ë°®ÊÉÖÂêç‰∏çËÉΩ‰∏∫Á©∫ÔºÅ"); }; event.target.value = null; });
            document.getElementById('upload-image-btn').addEventListener('click', () => document.getElementById('image-upload-input').click());
            document.getElementById('image-upload-input').addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file || !state.activeChatId) return; const reader = new FileReader(); reader.onload = async (e) => { const base64Url = e.target.result; const chat = state.chats[state.activeChatId]; const msg = { role: 'user', content: [{ type: 'image_url', image_url: { url: base64Url } }], timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); }; reader.readAsDataURL(file); event.target.value = null; });
            document.getElementById('voice-message-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const text = await showCustomPrompt("ÂèëÈÄÅËØ≠Èü≥", "ËØ∑ËæìÂÖ•‰Ω†ÊÉ≥ËØ¥ÁöÑÂÜÖÂÆπÔºö"); if (text && text.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'voice_message', content: text.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            document.getElementById('send-photo-btn').addEventListener('click', async () => { if (!state.activeChatId) return; const description = await showCustomPrompt("ÂèëÈÄÅÁÖßÁâá", "ËØ∑Áî®ÊñáÂ≠óÊèèËø∞ÊÇ®Ë¶ÅÂèëÈÄÅÁöÑÁÖßÁâáÔºö"); if (description && description.trim()) { const chat = state.chats[state.activeChatId]; const msg = { role: 'user', type: 'user_photo', content: description.trim(), timestamp: Date.now() }; chat.history.push(msg); await db.chats.put(chat); appendMessage(msg, chat); renderChatList(); } });
            
            // Persona Preset Event Listeners
            document.getElementById('open-persona-library-btn').addEventListener('click', openPersonaLibrary);
            document.getElementById('close-persona-library-btn').addEventListener('click', closePersonaLibrary);
            document.getElementById('add-persona-preset-btn').addEventListener('click', openPersonaEditorForCreate);
            document.getElementById('cancel-persona-editor-btn').addEventListener('click', closePersonaEditor);
            document.getElementById('save-persona-preset-btn').addEventListener('click', savePersonaPreset);
            document.getElementById('preset-action-edit').addEventListener('click', openPersonaEditorForEdit);
            document.getElementById('preset-action-delete').addEventListener('click', deletePersonaPreset);
            document.getElementById('preset-action-cancel').addEventListener('click', hidePresetActions);


            // Selection Event Listeners
            document.getElementById('selection-cancel-btn').addEventListener('click', exitSelectionMode);
            document.getElementById('selection-delete-btn').addEventListener('click', async () => { if (selectedMessages.size === 0) return; const confirmed = await showCustomConfirm('Âà†Èô§Ê∂àÊÅØ', `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedMessages.size} Êù°Ê∂àÊÅØÂêóÔºü`, { confirmButtonClass: 'btn-danger' }); if (confirmed) { const chat = state.chats[state.activeChatId]; chat.history = chat.history.filter(msg => !selectedMessages.has(msg.timestamp)); await db.chats.put(chat); renderChatInterface(state.activeChatId); renderChatList(); } });
            
            showScreen('home-screen');
        }
        init();
    });
    </script>
</body>
</html>
